{"version":3,"sources":["fileAttachmentThumbnailView.es6.js"],"names":[],"mappings":"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","file":"fileAttachmentThumbnailView.js","sourcesContent":["/**\n * Displays a thumbnail depicting a file attachment.\n *\n * There are two ways that Review Board currently renders file attachments.\n * One is on page load (as part of the initial page template), and the other\n * is dynamically (when uploading vs Drag and Drop or manual upload).\n *\n * Depending on the method, we either already have elements to work with,\n * or we don't. In the latter case, it's currently up to the caller to\n * tell us, using the renderThumbnail option.\n *\n * File attachments that aren't already on the page that are currently loading\n * will be displayed as a blank file attachment (no identifying information)\n * with a spinner. When loaded, it will appear as a standard file attachment.\n *\n * The following signals are provided, on top of the standard Backbone.View\n * signals:\n *\n *     * beginEdit\n *       - Editing of the file attachment (caption) has begun.\n *\n *     * endEdit\n *       - Editing of the file attachment (caption) has finished.\n *\n *     * commentSaved\n *       - A draft comment on the file has been saved.\n *         (Only for file attachments without a Review UI.)\n */\nRB.FileAttachmentThumbnail = Backbone.View.extend({\n    className: 'file-container',\n\n    events: {\n        'click .file-delete': '_onDeleteClicked',\n        'click .file-add-comment a': '_onAddCommentClicked',\n        'click .file-update a': '_onUpdateClicked',\n    },\n\n    template: _.template(dedent`\n        <div class=\"file\">\n         <div class=\"file-actions-container\">\n          <ul class=\"file-actions\"></ul>\n         </div>\n         <div class=\"file-thumbnail-container\"></div>\n         <div class=\"file-caption-container\">\n          <div class=\"file-caption can-edit\"><a href=\"<%- downloadURL %>\" class=\"<%- captionClass %>\"><%- caption %></a></div>\n         </div>\n        </div>\n        `),\n\n    actionsTemplate: _.template([\n        '<% if (loaded) { %>',\n        '<%  if (reviewURL) { %>',\n        '<li><a class=\"file-review\" href=\"<%- reviewURL %>\">',\n        '<span class=\"fa fa-comment-o\"></span> <%- reviewText %></a>',\n        '</li>',\n        '<%  } else { %>',\n        '<li class=\"file-add-comment\">',\n        '<a href=\"#\"><span class=\"fa fa-comment-o\"></span> <%- commentText %></a>',\n        '</li>',\n        '<%  } %>',\n        '<li><a class=\"file-download\" href=\"<%- downloadURL %>\">',\n        '<span class=\"fa fa-download\"></span> <%- downloadText %>',\n        '</a></li>',\n        '<%  if (canEdit) { %>',\n        '<%   if (attachmentHistoryID) { %>',\n        '<li class=\"file-update\">',\n        '<a href=\"#\" data-attachment-history-id=\"<%- attachmentHistoryID %>\">',\n        '<span class=\"fa fa-upload\"></span> <%- updateText %>',\n        '</a></li>',\n        '<%   } %>',\n        '<li class=\"file-delete\"><a href=\"#\">',\n        '<span class=\"fa fa-trash-o\"></span> <%- deleteText %>',\n        '</a></li>',\n        '<%  } %>',\n        '<% } %>',\n    ].join('')),\n\n    thumbnailContainerTemplate: _.template([\n        '<% if (!loaded) { %>',\n        '<span class=\"fa fa-spinner fa-pulse\"></span>',\n        '<% } else { %>',\n        '<%     if (reviewURL) { %>',\n        '<a href=\"<%- reviewURL %>\" class=\"file-thumbnail-overlay\"></a>',\n        '<%     } %>',\n        '<%=  thumbnailHTML %>',\n        '<% } %>',\n    ].join('')),\n\n    /**\n     * Initialize the view.\n     *\n     * Args:\n     *     options (object):\n     *         Options for the view.\n     *\n     * Option Args:\n     *     canEdit (boolean):\n     *         Whether the user has permission to edit the file attachment.\n     *\n     *     comments (Array):\n     *         The comments on the file attachment.\n     *\n     *     renderThumbnail (boolean):\n     *         Whether the thumbnail should be rendered. This exists because we\n     *         sometimes attach to existing DOM elements rather than rendering\n     *         from scratch.\n     *\n     *     reviewRequest (RB.ReviewRequest):\n     *         The review request model.\n     *\n     *     reviewRequestEditor (RB.ReviewRequestEditor):\n     *         The review request editor.\n     */\n    initialize(options) {\n        this.options = options;\n\n        this._draftComment = null;\n        this._comments = [];\n        this._commentsProcessed = false;\n        this._scrollingThumbnail = false;\n        this._playingVideo = false;\n    },\n\n    /**\n     * Render the file attachment, and hooks up all events.\n     *\n     * If the renderThumbnail option was provided when constructing the view,\n     * this will render the thumbnail from scratch, and then dynamically\n     * update it as it loads. It will start off displaying with a spinner,\n     * if not yet loaded.\n     *\n     * In either case, this will set up the caption editor and other signals\n     * to control the lifetime of the thumbnail.\n     *\n     * Returns:\n     *     RB.FileAttachmentThumbnail:\n     *     This object, for chaining.\n     */\n    render() {\n        /*\n         * Until FileAttachmentThumbnail is the only thing rendering thumbnails,\n         * we'll be in a situation where we may either be working with an\n         * existing DOM element (for existing file attachments), or a new one\n         * (for newly uploaded file attachments). In the latter case, we'll want\n         * to render our own thumbnail.\n         */\n        if (this.options.renderThumbnail) {\n            this._renderContents();\n        }\n\n        this._$captionContainer = this.$('.file-caption');\n        this._$caption = this._$captionContainer.find('a.edit');\n\n        this.listenTo(this.model, 'destroy', () => {\n            this.$el.fadeOut(() => this.remove());\n        });\n\n        this.listenTo(this.model, 'change:caption', this._onCaptionChanged);\n        this._onCaptionChanged();\n\n        this.$el.hover(this._onHoverIn.bind(this),\n                       this._onHoverOut.bind(this));\n\n        if (this.options.renderThumbnail) {\n            this._$actionsContainer = this.$('.file-actions-container');\n            this._$actions = this._$actionsContainer.children('.file-actions');\n            this._$captionContainer = this.$('.file-caption-container');\n            this._$thumbnailContainer = this.$('.file-thumbnail-container');\n            this._$file = this.$('.file');\n\n            this._$actions.find('.file-download')\n                .bindProperty('href', this.model, 'downloadURL', {\n                    elementToModel: false,\n                });\n\n            this._$caption.bindProperty('href', this.model, 'downloadURL', {\n                elementToModel: false,\n            });\n\n            this.listenTo(this.model, 'change:loaded', this._onLoadedChanged);\n            this._onLoadedChanged();\n\n            this.listenTo(this.model, 'change:thumbnailHTML',\n                          this._renderThumbnail);\n            this._renderThumbnail();\n        }\n\n        if (this.options.canEdit !== false) {\n            this._captionEditorView = new RB.InlineEditorView({\n                el: this._$caption,\n                editIconClass: 'rb-icon rb-icon-edit',\n                showButtons: true,\n            });\n            this._captionEditorView.render();\n\n            this.listenTo(this._captionEditorView, 'beginEditPreShow', () => {\n                this.$el.addClass('editing');\n                this._stopAnimating();\n            });\n\n            this.listenTo(this._captionEditorView, 'beginEdit', () => {\n                if (this._$caption.hasClass('empty-caption')) {\n                    this._captionEditorView.$field.val('');\n                }\n\n                this.trigger('beginEdit');\n            });\n\n            this.listenTo(this._captionEditorView, 'cancel', () => {\n                this.$el.removeClass('editing');\n                this.trigger('endEdit');\n            });\n\n            this.listenTo(this._captionEditorView, 'complete', (value) => {\n                this.$el.removeClass('editing');\n\n                /*\n                 * We want to set the caption after ready() finishes, in case\n                 * it loads state and overwrites.\n                 */\n                this.model.ready({\n                    ready: () => {\n                        this.model.set('caption', value);\n                        this.trigger('endEdit');\n                        this.model.save({\n                            attrs: ['caption'],\n                        });\n                    },\n                });\n            });\n        }\n\n        return this;\n    },\n\n    /**\n     * Fade the view in.\n     */\n    fadeIn() {\n        this.$el\n            .css('opacity', 0)\n            .fadeTo(1000, 1);\n    },\n\n    /**\n     * Show the comment dialog for the file attachment.\n     *\n     * This is only ever used if the file attachment does not have a\n     * Review UI for it. A single comment dialog will appear, allowing\n     * comments on the file as a whole.\n     */\n    showCommentDlg() {\n        console.assert(!this.model.get('reviewURL'),\n                       'showCommentDlg can only be called if the file ' +\n                       'attachment does not have a review UI');\n        this._processComments();\n        this._createDraftComment();\n\n        RB.CommentDialogView.create({\n            comment: this._draftComment,\n            publishedComments: this._comments,\n            publishedCommentsType: 'file_attachment_comments',\n            position: {\n                beside: {\n                    el: this.$el,\n                    side: 'br',\n                    fitOnScreen: true,\n                },\n            },\n        });\n    },\n\n    /**\n     * Process all comments provided when constructing the view.\n     *\n     * The comments will be made usable by the comment dialog.\n     *\n     * This is only used if the file attachment does not have a Review UI.\n     */\n    _processComments() {\n        if (this._commentsProcessed) {\n            return;\n        }\n\n        const comments = this.options.comments || [];\n\n        comments.forEach(comment => {\n            if (comment.localdraft) {\n                this._createDraftComment(comment.comment_id, comment.text);\n            } else {\n                this._comments.push(comment);\n            }\n        });\n\n        this._commentsProcessed = true;\n    },\n\n    /**\n     * Create a new draft comment with the given ID and text.\n     *\n     * Only one draft comment can be created at a time.\n     *\n     * This is only used if the file attachment does not have a Review UI.\n     *\n     * Args:\n     *     commentID (number):\n     *         The ID of the draft comment.\n     *\n     *     text (string):\n     *         The comment text.\n     */\n    _createDraftComment(commentID, text) {\n        if (this._draftComment !== null) {\n            return;\n        }\n\n        const review = this.options.reviewRequest.createReview();\n        this._draftComment = review.createFileAttachmentComment(commentID,\n                                                                this.model.id);\n\n        if (text) {\n            this._draftComment.set('text', text);\n        }\n\n        this.listenTo(this._draftComment, 'saved',\n                      () => this.trigger('commentSaved', this._draftComment));\n    },\n\n    /**\n     * Render the contents of this view's element.\n     *\n     * This is only done when requested by the caller.\n     */\n    _renderContents() {\n        const caption = this.model.get('caption');\n        const captionText = caption ? caption : gettext('No caption');\n        const captionClass = caption ? 'edit' : 'edit empty-caption';\n\n        this.$el\n            .html(this.template(_.defaults({\n                caption: captionText,\n                captionClass: captionClass,\n            }, this.model.attributes)))\n            .addClass(this.className);\n    },\n\n    /**\n     * Render the thumbnail for the file attachment.\n     */\n    _renderThumbnail() {\n        this._$thumbnailContainer.html(\n            this.thumbnailContainerTemplate(this.model.attributes));\n\n        Djblets.enableRetinaImages(this._$thumbnailContainer);\n\n        // Disable tabbing to any <a> elements inside the thumbnail.\n        this._$thumbnailContainer.find('a').each((i, el) => {\n            el.tabIndex = -1;\n        });\n    },\n\n    /**\n     * Handler for when the model's 'loaded' property changes.\n     *\n     * Depending on if the file attachment is now loaded, either a\n     * blank spinner thumbnail will be shown, or a full thumbnail.\n     */\n    _onLoadedChanged() {\n        this._$actions.html(this.actionsTemplate(_.defaults({\n            canEdit: this.options.canEdit,\n            deleteText: gettext('Delete'),\n            downloadText: gettext('Download'),\n            reviewText: gettext('Review'),\n            commentText: gettext('Comment'),\n            updateText: gettext('Update'),\n        }, this.model.attributes)));\n    },\n\n    /**\n     * Handler for when the model's caption changes.\n     *\n     * If a caption is set, the thumbnail will display it. Otherwise,\n     * it will display \"No caption\".\n     */\n    _onCaptionChanged() {\n        const caption = this.model.get('caption');\n\n        if (caption) {\n            this._$caption\n                .text(caption)\n                .removeClass('empty-caption');\n        } else {\n            this._$caption\n                .text(gettext('No caption'))\n                .addClass('empty-caption');\n        }\n    },\n\n    /**\n     * Handler for the New Comment button.\n     *\n     * Shows the comment dialog.\n     *\n     * Args:\n     *     e (Event):\n     *         The event that triggered the action.\n     */\n    _onAddCommentClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this.showCommentDlg();\n    },\n\n    /**\n     * Handler for the Update button.\n     *\n     * Shows the upload form.\n     *\n     * Args:\n     *     e (Event):\n     *         The event that triggered the action.\n     */\n    _onUpdateClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        const updateDlg = new RB.UploadAttachmentView({\n            attachmentHistoryID: $(e.target).data('attachment-history-id'),\n            presetCaption: this.model.get('caption'),\n            reviewRequestEditor: this.options.reviewRequestEditor,\n        });\n        updateDlg.show();\n    },\n\n    /**\n     * Handler for the Delete button.\n     *\n     * Deletes the file attachment from the review request draft.\n     *\n     * Args:\n     *     e (Event):\n     *         The event that triggered the action.\n     */\n    _onDeleteClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this.model.destroy();\n    },\n\n    /**\n     * Handler for when the mouse hovers over the thumbnail.\n     *\n     * Determines if we should scroll the thumbnail or not.\n     */\n    _onHoverIn() {\n        const $thumbnail = this.$('.file-thumbnail').children();\n        const actionsWidth = this._$actionsContainer.outerWidth();\n        const actionsRight = (this._$file.offset().left +\n                              this._$file.outerWidth() +\n                              actionsWidth);\n\n        this.trigger('hoverIn', this.$el);\n\n        /*\n         * Position the actions menu to the left or right of the attachment\n         * thumbnail.\n         */\n        if (actionsRight > $(window).width()) {\n            this._$actionsContainer\n                .css('left', -actionsWidth)\n                .addClass('left');\n        } else {\n            this._$actionsContainer\n                .css('left', '100%')\n                .addClass('right');\n        }\n\n        if (!this.$el.hasClass('editing') && $thumbnail.length === 1) {\n            const thumbnailEl = $thumbnail[0];\n\n            if (thumbnailEl.tagName === 'VIDEO') {\n                /* The thumbnail contains a video, so let's start playing it. */\n                const promise = thumbnailEl.play();\n\n                if (promise === undefined) {\n                    /* Older browsers don't return Promises. */\n                    this._playingVideo = true;\n                } else {\n                    promise\n                        .then(() => {\n                            this._playingVideo = true;\n                        })\n                        .catch(error => {\n                            /* Ignore the error. We just won't play it. */\n                            console.error(\n                                'Unable to play the video attachment: %s',\n                                error);\n                        });\n                }\n            } else {\n                /* Scroll the container to show all available content. */\n                const elHeight = this.$el.height();\n                const thumbnailHeight = $thumbnail.height() || 0;\n\n                if (thumbnailHeight > elHeight) {\n                    const distance = elHeight - thumbnailHeight;\n                    const duration =\n                        (Math.abs(distance) / 200) * 1000; // 200 pixels/s\n\n                    this._scrollingThumbnail = true;\n                    $thumbnail\n                        .delay(1000)\n                        .animate(\n                            { 'margin-top': distance + 'px' },\n                            {\n                                duration: duration,\n                                easing: 'linear',\n                            })\n                        .delay(500)\n                        .animate(\n                            { 'margin-top': 0 },\n                            {\n                                duration: duration,\n                                easing: 'linear',\n                                complete: () => {\n                                    this._scrollingThumbnail = false;\n                                },\n                            });\n                }\n            }\n        }\n    },\n\n    /**\n     * Handler for when the mouse stops hovering over the thumbnail.\n     *\n     * Removes the classes for the actions container, and stops animating\n     * the thumbnail contents.\n     */\n    _onHoverOut() {\n        this.trigger('hoverOut');\n\n        this._$actionsContainer\n            .removeClass('left')\n            .removeClass('right');\n\n        this._stopAnimating();\n    },\n\n    /**\n     * Stop animating this thumbnail.\n     *\n     * This is when moving the mouse outside of the thumbnail, or when the\n     * caption editor is opened.\n     */\n    _stopAnimating() {\n        if (this._scrollingThumbnail) {\n            this._scrollingThumbnail = false;\n            this.$('.file-thumbnail').children()\n                .stop(true)\n                .animate(\n                    { 'margin-top': 0 },\n                    { duration: 100 });\n        } else if (this._playingVideo) {\n            this._playingVideo = false;\n            this.$('video')[0].pause();\n        }\n    },\n});\n"]}