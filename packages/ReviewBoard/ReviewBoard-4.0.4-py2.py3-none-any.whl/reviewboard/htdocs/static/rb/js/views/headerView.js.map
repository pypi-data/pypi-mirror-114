{"version":3,"sources":["headerView.es6.js"],"names":[],"mappings":"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","file":"headerView.js","sourcesContent":["/**\n * Site Header\n */\nRB.HeaderView = Backbone.View.extend({\n    SEARCH_SUMMARY_TRIM_LEN: 28,\n    DESKTOP_SEARCH_RESULTS_WIDTH: 350,\n\n    events: {\n        'click #nav_toggle': '_handleNavClick',\n        'touchstart #nav_toggle': '_handleNavClick',\n        'focus #search_field': '_closeMobileMenu',\n    },\n\n    /**\n     * Initialize the header.\n     *\n     * Args:\n     *     options (object, optional):\n     *         Options for the view.\n     *\n     * Option Args:\n     *     $body (jQuery, optional):\n     *         The body element. This is useful for unit tests.\n     *\n     *     $pageSidebar (jQuery, optional):\n     *         The page sidebar element. This is useful for unit tests.\n     */\n    initialize(options={}) {\n        if (RB.HeaderView.instance !== null) {\n            console.warn('There are two instances of RB.HeaderView on the ' +\n                         'page. Make sure only one RB.PageView is ' +\n                         'instantiated and registered through ' +\n                         'RB.PageManager.setupPage().');\n        } else {\n            RB.HeaderView.instance = this;\n        }\n\n        this.options = options;\n\n        /*\n         * This is used by RB.PageManager to determine if a RB.PageView\n         * subclass has correctly rendered a HeaderView, or if PageManager\n         * needs to take care of it.\n         *\n         * This is deprecated and can be removed in Review Board 5.0.\n         */\n        this.isRendered = false;\n\n        this._mobileMenuOpened = false;\n\n        this._$window = null;\n        this._$body = null;\n        this._$navToggle = null;\n        this._$mobileMenuMask = null;\n    },\n\n    /**\n     * Remove the view from the DOM and disable event handling.\n     *\n     * This will also unset :js:attr:`RB.HeaderView.instance`, if currently\n     * set to this instance.\n     */\n    remove() {\n        if (RB.HeaderView.instance === this) {\n            RB.HeaderView.instance = null;\n        }\n\n        if (this._$window) {\n            this._$window.off('resize.rbHeaderView');\n        }\n\n        Backbone.View.prototype.remove.call(this);\n    },\n\n    /**\n     * Render the header.\n     *\n     * Returns:\n     *     RB.HeaderView:\n     *     This view, for chaining.\n     */\n    render() {\n        const options = this.options;\n\n        this._$window = $(window);\n        this._$body = options.body || $(document.body);\n        this._$navToggle = $('#nav_toggle');\n        this._$mobileMenuMask = $('<div id=\"mobile_menu_mask\"/>')\n            .on('click touchstart', this._closeMobileMenu.bind(this))\n            .insertAfter(options.$pageSidebar || $('#page-sidebar'));\n\n        this._$window.on('resize.rbHeaderView', _.throttle(\n            this._recalcMobileMode.bind(this),\n            100));\n        this._recalcMobileMode();\n\n        this._setupSearch();\n\n        this.isRendered = true;\n\n        return this;\n    },\n\n    /**\n     * Handle a click on the mobile navigation menu.\n     *\n     * Args:\n     *     e (Event):\n     *         The click event.\n     */\n    _handleNavClick(e) {\n        e.stopPropagation();\n        e.preventDefault();\n\n        this._setMobileMenuOpened(!this._mobileMenuOpened);\n    },\n\n    /**\n     * Recalculate whether the header and nav menu is in mobile mode.\n     */\n    _recalcMobileMode() {\n        const inMobileMode = this._$navToggle.is(':visible');\n\n        if (inMobileMode === this.inMobileMode) {\n            return;\n        }\n\n        if (!inMobileMode) {\n            this._setMobileMenuOpened(false);\n        }\n\n        this.inMobileMode = inMobileMode;\n        this.trigger('mobileModeChanged', inMobileMode);\n    },\n\n    /**\n     * Close the mobile menu.\n     *\n     * This is used as an event handler, to make it easy to close the\n     * mobile menu and prevent any bubbling or default actions from the\n     * event.\n     */\n    _closeMobileMenu() {\n        this._setMobileMenuOpened(false);\n\n        return false;\n    },\n\n    /**\n     * Set up the search auto-complete field.\n     */\n    _setupSearch() {\n        this._$search = $('#search_field').rbautocomplete({\n            formatItem: data => {\n                let s;\n\n                if (data.username) {\n                    // For the format of users:\n                    s = data.username;\n\n                    if (data.fullname) {\n                        s += ` <span>(${_.escape(data.fullname)})</span>`;\n                    }\n\n                } else if (data.name) {\n                    // For the format of groups:\n                    const displayName = _.escape(data.display_name);\n                    s = `${data.name} <span>(${displayName})</span>`;\n                } else if (data.summary) {\n                    // For the format of review requests:\n                    if (data.summary.length < this.SEARCH_SUMMARY_TRIM_LEN) {\n                        s = data.summary;\n                    } else {\n                        s = data.summary.substring(\n                            0, this.SEARCH_SUMMARY_TRIM_LEN);\n                    }\n\n                    s += ` <span>(${_.escape(data.id)})</span>`;\n                }\n\n                return s;\n            },\n            matchCase: false,\n            multiple: false,\n            clickToURL: true,\n            selectFirst: false,\n            width: this.DESKTOP_SEARCH_RESULTS_WIDTH,\n            enterToURL: true,\n            resultsParentEl: $('#page-container'),\n            resultsClass: 'ui-autocomplete-results search-results',\n            parse: data => {\n                const objects = ['users', 'groups', 'review_requests'];\n                const keys = ['username', 'name', 'summary'];\n\n                const parsed = [];\n\n                for (let j = 0; j < objects.length; j++) {\n                    const object = objects[j];\n                    const items = data.search[object];\n\n                    for (let i = 0; i < items.length; i++) {\n                        const value = items[i];\n                        const key = keys[j];\n\n\n                        if (j !== 2) {\n                            // For users and groups, always show.\n                            parsed.push({\n                                data: value,\n                                value: value[key],\n                                result: value[key],\n                            });\n                        } else if (value.public) {\n                            /*\n                             * For review requests, only show ones that are\n                             * public.\n                             */\n                            parsed.push({\n                                data: value,\n                                value: value[key],\n                                result: value[key],\n                            });\n                        }\n                    }\n                }\n\n                return parsed;\n            },\n            url: `${SITE_ROOT}api/search/`,\n        });\n    },\n\n    /**\n     * Set whether the mobile menu is opened.\n     *\n     * Args:\n     *     opened (boolean):\n     *         Whether the menu is open.\n     */\n    _setMobileMenuOpened(opened) {\n        if (opened === this._mobileMenuOpened) {\n            return;\n        }\n\n        if (opened) {\n            this._$mobileMenuMask.show();\n            _.defer(() => this._$body.addClass('js-mobile-menu-open'));\n        } else {\n            this._$body.removeClass('js-mobile-menu-open');\n            _.delay(() => this._$mobileMenuMask.hide(), 300);\n        }\n\n        this._mobileMenuOpened = opened;\n    },\n}, {\n    /** The instance of the HeaderView. */\n    instance: null,\n});\n"]}