{"version":3,"sources":["diffReviewableView.es6.js"],"names":[],"mappings":"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","file":"diffReviewableView.js","sourcesContent":["/*\n * Handles reviews of the diff for a file.\n *\n * This provides commenting abilities for ranges of lines on a diff, as well\n * as showing existing comments, and handling other interaction around\n * per-file diffs.\n */\nRB.DiffReviewableView = RB.AbstractReviewableView.extend({\n    tagName: 'table',\n\n    commentBlockView: RB.DiffCommentBlockView,\n    commentsListName: 'diff_comments',\n\n    events: {\n        'click .download-link': '_onDownloadLinkClicked',\n        'click thead tr': '_onFileHeaderClicked',\n        'click .moved-to, .moved-from': '_onMovedLineClicked',\n        'click .diff-collapse-btn': '_onCollapseChunkClicked',\n        'click .diff-expand-btn': '_onExpandChunkClicked',\n        'click .show-deleted-content-action': '_onShowDeletedClicked',\n        'mouseup': '_onMouseUp'\n    },\n\n    /**\n     * Initialize the reviewable for a file's diff.\n     */\n    initialize() {\n        RB.AbstractReviewableView.prototype.initialize.call(this);\n\n        this._selector = new RB.TextCommentRowSelector({\n            el: this.el,\n            reviewableView: this,\n        });\n\n        this._hiddenCommentBlockViews = [];\n        this._visibleCommentBlockViews = [];\n\n        /* State for keeping consistent column widths for diff content. */\n        this._$filenameRow = null;\n        this._$revisionRow = null;\n        this._filenameReservedWidths = 0;\n        this._colReservedWidths = 0;\n        this._numColumns = 0;\n        this._numFilenameColumns = 0;\n        this._prevContentWidth = null;\n        this._prevFilenameWidth = null;\n        this._prevFullWidth = null;\n\n        /*\n         * Wrap this only once so we don't have to re-wrap every time\n         * the page scrolls.\n         */\n        this._$window = $(window);\n        this._$parent = this.$el.parent();\n\n        this.on('commentBlockViewAdded', this._placeCommentBlockView, this);\n    },\n\n    /**\n     * Remove the reviewable from the DOM.\n     */\n    remove() {\n        RB.AbstractReviewableView.prototype.remove.call(this);\n\n        this._selector.remove();\n    },\n\n    /**\n     * Render the reviewable.\n     *\n     * Returns:\n     *     RB.DiffReviewableView:\n     *     This object, for chaining.\n     */\n    render() {\n        RB.AbstractReviewableView.prototype.render.call(this);\n\n        this._centered = new RB.CenteredElementManager();\n\n        const $thead = $(this.el.tHead);\n\n        this._$revisionRow = $thead.children('.revision-row');\n        this._$filenameRow = $thead.children('.filename-row');\n\n        this._selector.render();\n\n        _.each(this.$el.children('tbody.binary'), thumbnailEl => {\n            const $thumbnail = $(thumbnailEl);\n            const id = $thumbnail.data('file-id');\n            const $caption = $thumbnail.find('.file-caption .edit');\n            const reviewRequest = this.model.get('reviewRequest');\n            const fileAttachment = reviewRequest.createFileAttachment({\n                id: id,\n            });\n\n            if (!$caption.hasClass('empty-caption')) {\n                fileAttachment.set('caption', $caption.text());\n            }\n        });\n\n        this._precalculateContentWidths();\n        this._updateColumnSizes();\n\n        return this;\n    },\n\n    /*\n     * Toggles the display of whitespace-only chunks.\n     */\n    toggleWhitespaceOnlyChunks() {\n        this.$('tbody tr.whitespace-line').toggleClass('dimmed');\n\n        _.each(this.$el.children('tbody.whitespace-chunk'), chunk => {\n            const $chunk = $(chunk);\n            const dimming = $chunk.hasClass('replace');\n\n            $chunk.toggleClass('replace');\n\n            const $children = $chunk.children();\n            $children.first().toggleClass('first');\n            $children.last().toggleClass('last');\n\n            const chunkID = chunk.id.split('chunk')[1];\n\n            if (dimming) {\n                this.trigger('chunkDimmed', chunkID);\n            } else {\n                this.trigger('chunkUndimmed', chunkID);\n            }\n        });\n\n        /*\n         * Swaps the visibility of the \"This file has whitespace changes\"\n         * tbody and the chunk siblings.\n         */\n        this.$el.children('tbody.whitespace-file')\n            .siblings('tbody')\n            .addBack()\n                .toggle();\n    },\n\n   /**\n    * Create a comment for a chunk of a diff.\n    *\n    * Args:\n    *     beginLineNum (number)\n    *         The first line of the diff to comment on.\n    *\n    *     endLineNum (number):\n    *         The last line of the diff to comment on.\n    *\n    *     beginNode (Element):\n    *         The row corresponding to the first line of the diff being\n    *         commented upon.\n    *\n    *     endNode (Element):\n    *         The row corresponding to the last line of the diff being\n    *         commented upon.\n    */\n    createComment(beginLineNum, endLineNum, beginNode, endNode) {\n        this._selector.createComment(beginLineNum, endLineNum, beginNode,\n                                     endNode);\n    },\n\n    /**\n     * Place a CommentBlockView on the page.\n     *\n     * This will compute the row range for the CommentBlockView and then\n     * render it to the screen, if the row range exists.\n     *\n     * If it doesn't exist yet, the CommentBlockView will be stored in the\n     * list of hidden comment blocks for later rendering.\n     *\n     * Args:\n     *     commentBlockView (RB.DiffCommentBlockView):\n     *         The comment block view to place.\n     *\n     *     prevBeginRowIndex (number):\n     *         The row index to begin at. This places a limit on the rows\n     *         searched.\n     */\n    _placeCommentBlockView(commentBlockView, prevBeginRowIndex) {\n        const commentBlock = commentBlockView.model;\n\n        const rowEls = this._selector.getRowsForRange(\n            commentBlock.get('beginLineNum'),\n            commentBlock.get('endLineNum'),\n            prevBeginRowIndex);\n\n        if (rowEls !== null) {\n            const beginRowEl = rowEls[0];\n            const endRowEl = rowEls[1];\n\n            /*\n             * Note that endRow might be null if it exists in a collapsed\n             * region, so we can get away with just using beginRow if we\n             * need to.\n             */\n            commentBlockView.setRows($(beginRowEl), $(endRowEl || beginRowEl));\n            commentBlockView.$el.appendTo(\n                commentBlockView.$beginRow[0].cells[0]);\n            this._visibleCommentBlockViews.push(commentBlockView);\n\n            return beginRowEl.rowIndex;\n        } else {\n            this._hiddenCommentBlockViews.push(commentBlockView);\n            return prevBeginRowIndex;\n        }\n    },\n\n    /**\n     * Place any hidden comment blocks onto the diff viewer.\n     */\n    _placeHiddenCommentBlockViews() {\n        const hiddenCommentBlockViews = this._hiddenCommentBlockViews;\n        this._hiddenCommentBlockViews = [];\n        let prevBeginRowIndex;\n\n        for (let i = 0; i < hiddenCommentBlockViews.length; i++) {\n            prevBeginRowIndex = this._placeCommentBlockView(\n                hiddenCommentBlockViews[i], prevBeginRowIndex);\n        }\n    },\n\n    /**\n     * Mark any comment block views not visible as hidden.\n     */\n    _hideRemovedCommentBlockViews() {\n        const visibleCommentBlockViews = this._visibleCommentBlockViews;\n        this._visibleCommentBlockViews = [];\n\n        for (let i = 0; i < visibleCommentBlockViews.length; i++) {\n            const commentBlockView = visibleCommentBlockViews[i];\n\n            if (commentBlockView.$el.is(':visible')) {\n                this._visibleCommentBlockViews.push(commentBlockView);\n            } else {\n                this._hiddenCommentBlockViews.push(commentBlockView);\n            }\n        }\n\n        /* Sort these by line number so we can efficiently place them later. */\n        _.sortBy(\n            this._hiddenCommentBlockViews,\n            commentBlockView => commentBlockView.model.get('beginLineNum'));\n    },\n\n    /**\n     * Update the positions of the collapse buttons.\n     *\n     * This will attempt to position the collapse buttons such that they're\n     * in the center of the exposed part of the expanded chunk in the current\n     * viewport.\n     *\n     * As the user scrolls, they'll be able to see the button scroll along\n     * with them. It will not, however, leave the confines of the expanded\n     * chunk.\n     */\n    _updateCollapseButtonPos() {\n        this._centered.updatePosition();\n    },\n\n    /**\n     * Expands or collapses a chunk in a diff.\n     *\n     * This is called internally when an expand or collapse button is pressed\n     * for a chunk. It will fetch the diff and render it, displaying any\n     * contained comments, and setting up the resulting expand or collapse\n     * buttons.\n     *\n     * Args:\n     *     $btn (jQuery):\n     *         The expand/collapse button that was clicked.\n     *\n     *     expanding (boolean):\n     *          Whether or not we are expanding.\n     */\n    _expandOrCollapse($btn, expanding) {\n        const chunkIndex = $btn.data('chunk-index');\n        const linesOfContext = $btn.data('lines-of-context');\n\n        this.model.getRenderedDiffFragment({\n            chunkIndex: chunkIndex,\n            linesOfContext: linesOfContext,\n        }, {\n            success: html => {\n                const $tbody = $btn.closest('tbody');\n                let tbodyID;\n                let $scrollAnchor;\n                let scrollAnchorID;\n\n                /*\n                 * We want to position the new chunk or collapse button at\n                 * roughly the same position as the chunk or collapse button\n                 * that the user pressed. Figure out what it is exactly and what\n                 * the scroll offsets are so we can later reposition the scroll\n                 * offset.\n                 */\n                if (expanding) {\n                    $scrollAnchor = this.$el;\n                    scrollAnchorID = $scrollAnchor[0].id;\n\n                    if (linesOfContext === 0) {\n                        /*\n                         * We've expanded the entire chunk, so we'll be looking\n                         * for the collapse button.\n                         */\n                        tbodyID = /collapsed-(.*)/.exec(scrollAnchorID)[1];\n                    } else {\n                        tbodyID = scrollAnchorID;\n                    }\n                } else {\n                    $scrollAnchor = $btn;\n                }\n\n                const scrollOffsetTop = ($scrollAnchor.offset().top -\n                                         this._$window.scrollTop());\n\n                /*\n                 * If we already expanded, we may have one or two loaded chunks\n                 * adjacent to the header. We want to remove those, since we'll\n                 * be generating new ones that include that data.\n                 */\n                $tbody.prev('.diff-header, .loaded').remove();\n                $tbody.next('.diff-header, .loaded').remove();\n\n                /*\n                 * Replace the header with the new HTML. This may also include a\n                 * new header.\n                 */\n                $tbody.replaceWith(html);\n\n                if (expanding) {\n                    this._placeHiddenCommentBlockViews();\n                } else {\n                    this._hideRemovedCommentBlockViews();\n                }\n\n                /*\n                 * Get the new tbody for the header, if any, and try to center.\n                 */\n                if (tbodyID !== undefined) {\n                    const newEl = document.getElementById(tbodyID);\n\n                    if (newEl !== null) {\n                        $scrollAnchor = $(newEl);\n\n                        this._$window.scrollTop(\n                            $scrollAnchor.offset().top - scrollOffsetTop);\n                    }\n                }\n\n                /* Recompute the set of buttons for later use. */\n                this._centered.setElements(new Map(\n                    Array.prototype.map.call(\n                        this.$('.diff-collapse-btn'),\n                        el => [el, {\n                            $top: $(el).closest('tbody'),\n                        }])\n                ));\n                this._updateCollapseButtonPos();\n\n                /*\n                 * We'll need to update the column sizes, but first, we need\n                 * to re-calculate things like the line widths, since they\n                 * may be longer after expanding.\n                 */\n                this._precalculateContentWidths();\n                this._updateColumnSizes();\n\n                this.trigger('chunkExpansionChanged');\n            }\n        });\n    },\n\n    /**\n     * Pre-calculate the widths and other state needed for column widths.\n     *\n     * This will store the number of columns and the reserved space that\n     * needs to be subtracted from the container width, to be used in later\n     * calculating the desired widths of the content areas.\n     */\n    _precalculateContentWidths() {\n        let cellPadding = 0;\n\n        if (!this.$el.hasClass('diff-error') && this._$revisionRow.length > 0) {\n            const containerExtents = this.$el.getExtents('p', 'lr');\n\n            /* Calculate the widths and state of the diff columns. */\n            let $cells = $(this._$revisionRow[0].cells);\n            cellPadding = $(this.el.querySelector('pre'))\n                .parent().addBack()\n                .getExtents('p', 'lr');\n\n            this._colReservedWidths = $cells.eq(0).outerWidth() + cellPadding +\n                                      containerExtents;\n            this._numColumns = $cells.length;\n\n            if (this._numColumns === 4) {\n                /* There's a left-hand side and a right-hand side. */\n                this._colReservedWidths += $cells.eq(2).outerWidth() +\n                                           cellPadding;\n            }\n\n            /* Calculate the widths and state of the filename columns. */\n            $cells = $(this._$filenameRow[0].cells);\n            this._numFilenameColumns = $cells.length;\n            this._filenameReservedWidths = containerExtents +\n                                           2 * this._numFilenameColumns;\n        } else {\n            this._colReservedWidths = 0;\n            this._filenameReservedWidths = 0;\n            this._numColumns = 0;\n            this._numFilenameColumns = 0;\n        }\n    },\n\n    /*\n     * Update the sizes of the diff content columns.\n     *\n     * This will figure out the minimum and maximum widths of the columns\n     * and set them in a stylesheet, ensuring that lines will constrain to\n     * those sizes (force-wrapping if necessary) without overflowing or\n     * causing the other column to shrink too small.\n     */\n    _updateColumnSizes() {\n        if (this.$el.hasClass('diff-error')) {\n            return;\n        }\n\n        let $parent = this._$parent;\n\n        if (!$parent.is(':visible')) {\n            /*\n             * We're still in diff loading mode, and the parent is hidden. We\n             * can get the width we need from the parent. It should be the same,\n             * or at least close enough for the first stab at column sizes.\n             */\n            $parent = $parent.parent();\n        }\n\n        const fullWidth = $parent.width();\n\n        if (fullWidth === this._prevFullWidth) {\n            return;\n        }\n\n        this._prevFullWidth = fullWidth;\n\n        /* Calculate the desired widths of the diff columns. */\n        let contentWidth = fullWidth - this._colReservedWidths;\n\n        if (this._numColumns === 4) {\n            contentWidth /= 2;\n        }\n\n        /* Calculate the desired widths of the filename columns. */\n        let filenameWidth = fullWidth - this._filenameReservedWidths;\n\n        if (this._numFilenameColumns === 2) {\n            filenameWidth /= 2;\n        }\n\n        this.$el.width(fullWidth);\n\n        /* Update the minimum and maximum widths, if they've changed. */\n        if (filenameWidth !== this._prevFilenameWidth) {\n            this._$filenameRow.children('th').css({\n                'min-width': Math.ceil(filenameWidth * 0.66),\n                'max-width': Math.ceil(filenameWidth)\n            });\n            this._prevFilenameWidth = filenameWidth;\n        }\n\n        if (contentWidth !== this._prevContentWidth) {\n            this._$revisionRow.children('.revision-col').css({\n                'min-width': Math.ceil(contentWidth * 0.66),\n                'max-width': Math.ceil(contentWidth)\n            });\n            this._prevContentWidth = contentWidth;\n        }\n    },\n\n    /**\n     * Handle a window resize.\n     *\n     * This will update the sizes of the diff columns, and the location of the\n     * collapse buttons (if one or more are visible).\n     */\n    updateLayout() {\n        this._updateColumnSizes();\n        this._updateCollapseButtonPos();\n    },\n\n    /**\n     * Handle a file download link being clicked.\n     *\n     * Prevents the event from bubbling up and being caught by\n     * _onFileHeaderClicked.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The ``click`` event that triggered this handler.\n     */\n    _onDownloadLinkClicked(e) {\n        e.stopPropagation();\n    },\n\n    /**\n     * Handle the file header being clicked.\n     *\n     * This will highlight the file header.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The ``click`` event that triggered this handler.\n     */\n    _onFileHeaderClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this.trigger('fileClicked');\n    },\n\n    /**\n     * Handle a \"Moved to/from\" flag being clicked.\n     *\n     * This will scroll to the location on the other end of the move,\n     * and briefly highlight the line.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The ``click`` event that triggered this handler.\n     */\n    _onMovedLineClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this.trigger('moveFlagClicked', $(e.target).data('line'));\n    },\n\n    /**\n     * Handle a mouse up event.\n     *\n     * This will select any chunk that was clicked, highlight the chunk,\n     * and ensure it's cleanly scrolled into view.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The ``mouseup`` event that triggered this handler.\n     */\n    _onMouseUp(e) {\n        const node = e.target;\n\n        /*\n         * The user clicked somewhere else. Move the anchor point here\n         * if it's part of the diff.\n         */\n        const $tbody = $(node).closest('tbody');\n\n        if ($tbody.length > 0 &&\n            ($tbody.hasClass('delete') ||\n             $tbody.hasClass('insert') ||\n             $tbody.hasClass('replace'))) {\n            const anchor = $tbody[0].querySelector('a');\n\n            if (anchor) {\n                this.trigger('chunkClicked', anchor.name);\n            }\n        }\n    },\n\n    /**\n     * Handle an expand chunk button being clicked.\n     *\n     * The expand buttons will expand a collapsed chunk, either entirely\n     * or by certain amounts. It will fetch the new chunk contents and\n     * inject it into the diff viewer.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The ``click`` event that triggered this handler.\n     */\n    _onExpandChunkClicked(e) {\n        e.preventDefault();\n\n        let $target = $(e.target);\n\n        if (!$target.hasClass('diff-expand-btn')) {\n            /* We clicked an image inside the link. Find the parent. */\n            $target = $target.closest('.diff-expand-btn');\n        }\n\n        this._expandOrCollapse($target, true);\n    },\n\n    /**\n     * Handle a collapse chunk button being clicked.\n     *\n     * The fully collapsed representation of that chunk will be fetched\n     * and put into the diff viewer in place of the expanded chunk.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The ``click`` event that triggered this handler.\n     */\n    _onCollapseChunkClicked(e) {\n        e.preventDefault();\n\n        let $target = $(e.target);\n\n        if (!$target.hasClass('diff-collapse-btn')) {\n            /* We clicked an image inside the link. Find the parent. */\n            $target = $target.closest('.diff-collapse-btn');\n        }\n\n        this._expandOrCollapse($target, false);\n    },\n\n    /**\n     * Handler for when show content is clicked.\n     *\n     * This requeues the corresponding diff to show its deleted content.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The ``click`` event that triggered this handler.\n     */\n    _onShowDeletedClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        /*\n         * Replace the current contents (\"This file was deleted ... \") with a\n         * spinner. This will be automatically replaced with the file contents\n         * once loaded from the server.\n         */\n        $(e.target).parent()\n            .html('<span class=\"fa fa-spinner fa-pulse\"></span>');\n\n        this.trigger('showDeletedClicked');\n    },\n});\n"]}