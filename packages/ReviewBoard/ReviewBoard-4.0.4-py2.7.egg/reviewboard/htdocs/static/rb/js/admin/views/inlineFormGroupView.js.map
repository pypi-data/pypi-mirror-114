{"version":3,"sources":["inlineFormGroupView.es6.js"],"names":[],"mappings":"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","file":"inlineFormGroupView.js","sourcesContent":["/**\n * A view for managing a group of inline forms for related model objects.\n *\n * This takes care of managing the form data and rendering of multiple inline\n * forms, allowing the addition of new inline forms (up to the configured\n * limit for the model), ensuring there's a minimum available, and tracking\n * what needs to be sent to the server when saving the model.\n *\n * There's an expectation that the last form provided in the group is going to\n * be a template used for any new forms that are added.\n */\nRB.Admin.InlineFormGroupView = Backbone.View.extend({\n    events: {\n        'click .rb-c-admin-form-inline-group__add-action': '_onAddClicked',\n    },\n\n    /**\n     * Initialize the view.\n     */\n    initialize() {\n        this._$addButton = null;\n        this._$inlineTemplate = null;\n        this._$inlines = null;\n        this._inlineViews = [];\n    },\n\n    /**\n     * Render the view.\n     *\n     * Returns:\n     *     RB.Admin.InlineFormGroupView:\n     *     This object, for chaining.\n     */\n    render() {\n        const model = this.model;\n        const prefix = model.get('prefix');\n\n        const $inlines = this.$el.children(\n            '.rb-c-admin-form-inline-group__inlines');\n        console.assert($inlines.length === 1);\n\n        const $actions = this.$el.children(\n            '.rb-c-admin-form-inline-group__actions');\n        console.assert($actions.length === 1);\n\n        const $addButton = $actions.children(\n            '.rb-c-admin-form-inline-group__add-action');\n        console.assert($addButton.length === 1);\n\n        this._$inlines = $inlines;\n\n        /*\n         * Set up and store the template for later use. We'll remove it from\n         * the DOM so we don't end up binding anything to it.\n         */\n        this._$inlineTemplate = $inlines.children('.-is-template')\n            .detach()\n            .removeClass('-is-template');\n        console.assert(this._$inlineTemplate.length === 1);\n\n        /*\n         * Populate the state in the model.\n         *\n         * The form field names come from Django's own ManagementForm\n         * (django.forms.formsets), and are outside our control. They may need\n         * to be updated if Django reworks their naming or logic, though this\n         * is probably unlikely.\n         */\n        const $initialForms = $inlines.children(`#id_${prefix}-INITIAL_FORMS`);\n        const $maxNumForms = $inlines.children(`#id_${prefix}-MAX_NUM_FORMS`);\n        const $minNumForms = $inlines.children(`#id_${prefix}-MIN_NUM_FORMS`);\n        const $totalForms = $inlines.children(`#id_${prefix}-TOTAL_FORMS`);\n\n        console.assert($initialForms.length === 1);\n        console.assert($maxNumForms.length === 1);\n        console.assert($minNumForms.length === 1);\n        console.assert($totalForms.length === 1);\n\n        const maxInlines = $maxNumForms.val();\n\n        model.set({\n            initialInlines: parseInt($initialForms.val(), 10),\n            maxInlines: maxInlines === '' ? null : parseInt(maxInlines, 10),\n            minInlines: parseInt($minNumForms.val(), 10),\n        });\n\n        /*\n         * Update the total forms state and the visibility of the Add button\n         * whenever we change the number of inlines in the group. This will also\n         * update just below when we first populate the value on the model.\n         */\n        this.listenTo(model.inlines, 'update', () => {\n            $addButton.setVisible(model.canAddInline());\n            $totalForms.val(model.inlines.length);\n        });\n\n        this.listenTo(model.inlines, 'remove', this._onInlineRemoved);\n\n        /*\n         * Create and track views for every inline.\n         */\n        $inlines.children('.rb-c-admin-form-inline').each((index, el) => {\n            this._setupInlineForm(el, {\n                index: index,\n                isInitial: true,\n            });\n        });\n\n        console.assert(\n            parseInt($totalForms.val(), 10) === model.inlines.length);\n\n        return this;\n    },\n\n    /**\n     * Add a new inline form.\n     *\n     * This will add a new inline form and register it, scheduling it to be\n     * sent to the server when the main form is submitted.\n     *\n     * Returns:\n     *     RB.Admin.InlineFormView:\n     *     The new inline form view.\n     */\n    addInlineForm() {\n        const newIndex = this.model.inlines.length;\n\n        const $inline = this._$inlineTemplate.clone();\n        const view = this._setupInlineForm($inline[0]);\n        view.model.set('index', newIndex);\n\n        this._$inlines.append($inline);\n\n        this.trigger('inlineFormAdded', view);\n\n        return view;\n    },\n\n    /**\n     * Set up an inline form.\n     *\n     * This will construct a :js:class:`RB.Admin.InlineFormView` for the\n     * element, show it, and update any form state.\n     *\n     * Args:\n     *     el (Element):\n     *         The element representing the inline form.\n     *\n     *     attrs (object):\n     *         Attributes for the model.\n     *\n     * Returns:\n     *     RB.Admin.InlineFormView:\n     *     The new view for the element.\n     */\n    _setupInlineForm(el, attrs) {\n        const model = this.model;\n\n        const inline = new RB.Admin.InlineForm(_.extend({\n            prefix: model.get('prefix'),\n        }, attrs));\n\n        const inlineView = new RB.Admin.InlineFormView({\n            el: el,\n            model: inline,\n        });\n        inlineView.render();\n\n        this._inlineViews.push(inlineView);\n        model.inlines.add(inline);\n\n        return inlineView;\n    },\n\n    /**\n     * Handle the removal of an inline form.\n     *\n     * This will remove the inline form and its view from the page, and update\n     * the indexes of all other inline forms.\n     *\n     * Args:\n     *     inline (RB.Admin.InlineForm):\n     *         The inline form that was removed.\n     */\n    _onInlineRemoved(inline) {\n        const index = inline.get('index');\n        const inlineView = this._inlineViews[index];\n\n        this._inlineViews.splice(index, 1);\n        inlineView.remove();\n\n        /* Update the indexes of all remaining form views. */\n        this._inlineViews.forEach((view, i) => view.model.set('index', i));\n\n        this.trigger('inlineFormRemoved', inlineView);\n    },\n\n    /**\n     * Handle an click on Add <inline name>.\n     *\n     * This will add a new inline form view.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The click event.\n     */\n    _onAddClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this.addInlineForm();\n    },\n});\n"]}