"use strict";(self.webpackChunkjupyterlab_citation_manager=self.webpackChunkjupyterlab_citation_manager||[]).push([[725],{725:(t,e,i)=>{i.r(e),i.d(e,{default:()=>Ot,itemIdToPrimitive:()=>At});var n=i(194),a=i(406),s=i(749),o=i(114),r=i(797);const c=new r.Token("@krassowski/citation-manager:ICitationManager");var l;!function(t){t.open="cm:open-reference",t.insertCitation="cm:insert-citation",t.insertBibliography="cm:insert-bibliography",t.changeBibliographyStyle="cm:change-bibliography-style",t.updateReferences="cm:update-references"}(l||(l={}));var d=i(79);const h='<svg width="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n  <g class="jp-icon3 jp-icon-selectable" fill="#4F4F4F">\n    <path d="M13 19C13 20.1 13.3 21.12 13.81 22H6C4.89 22 4 21.11 4 20V4C4 2.9 4.89 2 6 2H7V9L9.5 7.5L12 9V2H18C19.1 2 20 2.89 20 4V13.09C19.67 13.04 19.34 13 19 13C15.69 13 13 15.69 13 19M20 18V15H18V18H15V20H18V23H20V20H23V18H20Z" />\n  </g>\n</svg>';var u=i(567),m=i(160),p=i(276),g=i(168),f=i(271),b=i(80);class v extends u.ReactWidget{constructor(t){super(),this.signal=t}render(){return f.createElement(u.UseSignal,{signal:this.signal},((t,e)=>e?("started"===e.state&&(e.value=0),"ongoing"===e.state&&e.value?f.createElement("div",{className:"cm-ProgressBar",title:e.tooltip||""},f.createElement("span",null,e.label||""),f.createElement(b.ProgressBar,{percentage:e.value})):f.createElement("div",null)):null))}}const y=new d.LabIcon({name:"citation:zotero",svgstr:h}),w="jupyterlab-citation-manager:zotero";function C(t){const e=new Map;for(const i of t.split(",")){const t=i.split(";"),n=/<(.*?)>/.exec(t[0]);if(!n)throw"Could not parse URL of Zotero link";const a=/ ?rel="(.*?)"/.exec(t[1]);if(!a)throw"Could not parse rel of Zotero link";const s=a[1];e.set(s,{rel:s,url:n[1]})}return e}class _{constructor(t){this.headers=t,this.backoffSeconds=this.parseIntIfPresent("Backoff"),this.lastModifiedVersion=this.headers.get("Last-Modified-Version"),this.apiVersion=this.headers.get("Zotero-API-Version")}parseIntIfPresent(t){const e=this.headers.get(t);if(!e)return null;try{return parseInt(e,10)}catch(t){return console.warn("Failed to parse backoff time from Zotero API response headers"),null}}}class I{constructor(t,e,i){this.settings=t,this.trans=e,this.state=i,this.id="zotero",this.name="Zotero",this.icon=y,this._serverURL=null,this._key=null,this._user=null,this.lastModifiedLibraryVersion=null,this.apiVersion="3",this.persistentCacheVersion="0..",this.progress=new g.Signal(this),this.citableItems=new Map,t.changed.connect(this.updateSettings,this);const n=[this.updateSettings(t)];i&&n.push(this.restoreStateFromCache(i)),this.isReady=Promise.all(n),this.backoffPassed=new Promise((t=>{t()}))}async restoreStateFromCache(t){return new Promise((e=>{t.fetch(w).then((t=>{if(t){const e=t;if(e.apiVersion&&e.apiVersion!==this.apiVersion)return;if(e.persistentCacheVersion&&e.persistentCacheVersion!==this.persistentCacheVersion)return;this.lastModifiedLibraryVersion=e.lastModifiedLibraryVersion,e.citableItems&&(this.citableItems=new Map([...Object.entries(e.citableItems)]),console.log(`Restored ${this.citableItems.size} citable items from cache`)),this.updateCacheState()}else console.log("No previous state found for Zotero in the StateDB (it is normal on first run)")})).catch(console.warn).finally((()=>e()))}))}async fetch(t,e={},i=!1,n=!1){if(!this._key){const t=await u.InputDialog.getPassword({title:this.trans.__("Configure Zotero API Access _key"),label:this.trans.__("In order to access your Zotero collection you need to configure Zotero API key.\n          You can generate the API key after logging to www.zotero.org.\n          The key looks like this: P9NiFoyLeZu2bZNvvuQPDWsd.")});if(!t.value)return;this._key=t.value,this.settings.set("_key",this._key).catch(console.warn)}const a={"Zotero-API-Key":this._key,"Zotero-API-Version":this.apiVersion};return!n&&i&&this.lastModifiedLibraryVersion&&(a["If-Modified-Since-Version"]=this.lastModifiedLibraryVersion),await this.backoffPassed,fetch(this._serverURL+"/"+t+"?"+new URLSearchParams(e),{method:"GET",headers:a}).then((t=>(this.processResponseHeaders(t.headers,i),t)))}processResponseHeaders(t,e){const i=new _(t);this.handleBackoff(i.backoffSeconds),e&&i.lastModifiedVersion&&(this.lastModifiedLibraryVersion=i.lastModifiedVersion),i.apiVersion&&i.apiVersion!==this.apiVersion&&console.warn(`Zotero servers moved to a newer version API (${i.apiVersion}, but this client only supports ${this.apiVersion}); please consider contributing a code to update this client to use the latest API`)}handleBackoff(t){t&&(this.backoffPassed=new Promise((e=>{window.setTimeout(e,t)})))}async updatePublications(t=!1){var e;const i={label:this.trans.__("Zotero sync."),tooltip:this.trans.__("Connector for Zotero is synchronizing references...")};this.progress.emit({...i,state:"started"});const n=await this.loadAll("users/"+(null===(e=this._user)||void 0===e?void 0:e.id)+"/items","csljson","items",!0,t,(t=>{this.progress.emit({...i,state:"ongoing",value:t})})).finally((()=>{this.progress.emit({...i,state:"completed"})}));return n?(console.log(`Fetched ${null==n?void 0:n.length} citable items from Zotero`),this.citableItems=new Map((n||[]).map((t=>{const e=t;return[e.id+"",e]}))),this.updateCacheState().catch(console.warn)):console.log("No new items fetched from Zotero"),[...this.citableItems.values()]}async updateCacheState(){if(!this.state)return;const t={persistentCacheVersion:this.persistentCacheVersion,apiVersion:this.apiVersion,lastModifiedLibraryVersion:this.lastModifiedLibraryVersion,citableItems:Object.fromEntries(this.citableItems)};return this.state.save(w,t)}async loadAll(t,e="csljson",i,n=!0,a=!1,s){var o;let r=await this.fetch(t,{format:e},n,a);if(304===(null==r?void 0:r.status))return console.log(`Received 304 status (${null==r?void 0:r.statusText}), skipping...`),null;const c=[],l=parseInt(null==r?void 0:r.headers.get("Total-Results"),10)||1e4;let d=0,h=!1;for(;!h&&d<=l;){if(!r)return void console.log("Could not retrieve all pages for ",t);c.push(r);const i=null===(o=C(null==r?void 0:r.headers.get("Link")).get("next"))||void 0===o?void 0:o.url;if(i){const a=Object.fromEntries(new URLSearchParams(new URL(i).search).entries());a.start&&(d+=parseInt(a.start,10),s&&s(100*d/l)),r=await this.fetch(t,{...a,format:e},n,!0)}else h=!0,s&&s(100)}const u=[];for(const t of c){let e=await t.json();i&&(e=e[i]);for(const t of e)u.push(t)}return u}reloadKey(){return this.fetch("keys/"+this._key).then((t=>{if(t)return t.json().then((t=>(this._user={name:t.username,id:t.userID},this.updatePublications())));console.error(t)}))}updateSettings(t){return this._key=t.composite.key,this._serverURL=t.composite.server,this.reloadKey()}}const S={id:w,requires:[c,a.ISettingRegistry],optional:[m.ITranslator,p.IStateDB,b.IStatusBar],autoStart:!0,activate:(t,e,i,n,a,s)=>{console.log("JupyterLab citation manager provider of Zotero is activated!");const o=(n=n||m.nullTranslator).load("jupyterlab-citation-manager");i.load(S.id).then((t=>{const i=new I(t,o,a);e.registerReferenceProvider(i),console.log("jupyterlab-citation-manager:zotero settings loaded:",t.composite),s&&s.registerStatusItem(w,{item:new v(i.progress),rank:900})})).catch((t=>{console.error("Failed to load settings for jupyterlab-citation-manager:zotero.",t)}))}};var k=i(137),E=i.n(k);function x(t){return null==t?1/0:t}function A(t){let e=!1,i="";for(;!e;)i=Math.random().toString(36).slice(-5),e=!t.has(i);return i}class M{constructor(t){this.factory=t,this.map=new Map}get(t){return this.map.has(t)?this.map.get(t):this.factory(t)}set(t,e){this.map.set(t,e)}entries(){return this.map.entries()}keys(){return this.map.keys()}values(){return this.map.values()}}function O(t){return t.content.widgets.filter((t=>"markdown"===t.model.type))}function P(t){return t&&(null==t?void 0:t.textContent)||""}function D(t,e,i){const n=E()(t),a=document.createElement("div");return a.innerHTML=n,[...a.querySelectorAll("cite").values()].map((t=>{const n={before:P(t.previousSibling),citation:t.innerHTML,after:P(t.nextSibling)};let a=i[t.id?t.id:t.dataset.cite];return a||(a=t.dataset.items?t.dataset.items.startsWith("[")?JSON.parse(t.dataset.items):[{source:t.dataset.source,id:t.dataset.items}]:[]),{citationId:t.id,items:a,text:t.innerHTML,data:t.dataset,context:{...e,excerpt:n}}}))}function B(t){return new Date(t)}function L(t){let e;return t.issued&&(e=function(t){if("string"==typeof t)return B(t);if(t.edtf)return B(t.edtf);if(t.raw)return new Date(t.raw);if(t.literal)return new Date(t.literal);if(t["date-parts"]){const e=t["date-parts"][0];if(1===e.length)return new Date(parseInt(e[0]+"",10),6);if(2===e.length)return new Date(...e.map((t=>parseInt(t+"",10))));if(3===e.length)return new Date(...e.map((t=>parseInt(t+"",10))));console.warn(`Don't know how to parse date-parts: ${e}`)}return new Date}(t.issued)),{...t,date:e}}var N=i(686),R=i(850),T=i(706),F=i(608);const j="cm-mod-active",V="lm-mod-focused";function H(t){return f.createElement("mark",{key:r.UUID.uuid4()},t)}class W extends u.ReactWidget{constructor(t){super(),this.input=null,this.defaultConfig={debounceRate:250,debounceOptionNumberThreshold:200},this.placeholder="Search",this._config={...this.defaultConfig,...t},this._debouncedChanged=new o.dx((()=>{this.emitChangedSignal()}),this._config.debounceRate),this._query="",this.options=[],this._optionsChanged=new g.Signal(this),this._filteredOptions=this.transformOptions(this.getInitialOptions()),this._reject=()=>0,this._accept=t=>0,this._previousPromise=null,this.activeIndex=0,this.activeChanged=new g.Signal(this),this.node.tabIndex=0}get model(){return this._config.model}emitChangedSignal(){this._optionsChanged.emit(this._filteredOptions)}createID(t){return JSON.stringify(t)}getInitialOptions(){return this.model.initialOptions?this.model.initialOptions(this.options):[]}transformOptions(t){return t.map((t=>({data:t,match:null,id:this.createID(t)})))}getOptionNodes(){return this.node.querySelectorAll(".cm-OptionsList li.cm-Option")}handleInput(t){this._query=t.target.value,this._filteredOptions=this.options.map((t=>({match:this.model.match(t,this._query),data:t,id:this.createID(t)}))).filter(this.model.filter).sort(this.model.sort),this.setActiveIndex(0),this._debouncedChanged.invoke().catch(console.warn)}renderOption(t){const e=t.option.data;return f.createElement("div",{className:"cm-Option-content"},JSON.stringify(e))}dynamicClassForList(t){return""}render(){return f.createElement("div",{className:"cm-Selector"},f.createElement("div",{className:"cm-SearchField-outer-wrapper"},f.createElement("div",{className:"cm-SearchField-wrapper"},f.createElement("input",{placeholder:this.placeholder,onInput:this.handleInput.bind(this),className:"cm-SearchField",ref:t=>{this.input=t},onBlur:()=>{this.input&&this.input.parentElement&&this.input.parentElement.classList.remove(V)},onFocus:()=>{this.input&&this.input.parentElement&&this.input.parentElement.classList.add(V)},autoFocus:!0}),f.createElement(d.searchIcon.react,{className:"cm-SearchIcon"}))),f.createElement(u.UseSignal,{signal:this._optionsChanged},((t,e)=>{const i=e;if(!i)return"";const n=i.map(((t,e)=>{const i=this.activeIndex===e?"cm-Option cm-mod-active":"cm-Option",n=this.renderOption.bind(this);return f.createElement("li",{className:i,key:t.id,onClick:(()=>{this.acceptOption(t.data)}).bind(this)},f.createElement(n,{option:t}))}));return f.createElement("ul",{className:`cm-OptionsList ${this.dynamicClassForList(i)}`},n)}).bind(this)))}hideAndReset(){this.hide(),this._previousPromise&&this._reject(),this._previousPromise=null,this.input&&(this.input.value="")}acceptOption(t){if(t||this._filteredOptions.length&&(t=this._filteredOptions[this.activeIndex].data),t){const e=this._filteredOptions.findIndex((e=>e.data===t));-1!==e&&this.setActiveIndex(e),this._accept(t),this._previousPromise=null}else this._previousPromise&&(this._reject(),this._previousPromise=null)}setActiveIndex(t){const e=this.getOptionNodes();if(!e.length)return;e[this.activeIndex].classList.remove(j),this.activeIndex=t;const i=e[this.activeIndex];e[this.activeIndex].classList.add(j),F.ElementExt.scrollIntoViewIfNeeded(i.parentElement,i),this.activeChanged.emit(this._filteredOptions[this.activeIndex].data)}cycle(t){const e=this.activeIndex,i=this._filteredOptions;let n;switch(t){case"down":n=e===i.length-1?0:e+1;break;case"up":n=0===e?i.length-1:e-1;break;case"page down":n=e+10>=i.length-1?i.length-1:e+10;break;case"page up":n=e-10<=0?0:e-10;break;case"end":n=i.length-1;break;case"home":n=0}this.setActiveIndex(n)}_evtKeydown(t){switch(t.keyCode){case 13:this.acceptOption();break;case 40:this.cycle("down");break;case 38:this.cycle("up");break;case 34:this.cycle("page down");break;case 33:this.cycle("page up");break;case 35:this.cycle("end");break;case 36:this.cycle("home")}}getItem(t){return this._previousPromise&&this._reject(),this.setActiveIndex(0),this.options=t,this._filteredOptions=this.transformOptions(this.getInitialOptions()),this._optionsChanged.emit(this._filteredOptions),this.setActiveIndex(0),new Promise(((t,e)=>{this._accept=t,this._reject=e}))}handleEvent(t){switch(t.type){case"keydown":this._evtKeydown(t)}}onAfterAttach(t){super.onAfterAttach(t),this.node.addEventListener("keydown",this,!0)}onAfterDetach(t){this.node.removeEventListener("keydown",this,!0)}}class $ extends W{constructor(t){super(t),this.addClass("cm-ModalSelector"),this.node.tabIndex=0}_evtKeydown(t){switch(t.keyCode){case 27:t.stopPropagation(),t.preventDefault(),this.hideAndReset();break;default:super._evtKeydown(t)}}getItem(t){const e=super.getItem(t);return this.show(),this.isAttached||this.attach(),e}acceptOption(t){super.acceptOption(t),this.hideAndReset()}attach(){T.Widget.attach(this,document.body)}detach(){T.Widget.detach(this)}handleEvent(t){switch(super.handleEvent(t),t.type){case"blur":this.node.contains(t.target)&&!this.node.contains(t.relatedTarget)&&(t.stopPropagation(),this.hideAndReset());break;case"contextmenu":t.preventDefault(),t.stopPropagation()}}onAfterAttach(t){super.onAfterAttach(t),this.node.addEventListener("contextmenu",this,!0)}onAfterDetach(t){super.onAfterDetach(t),this.node.removeEventListener("contextmenu",this,!0)}onBeforeHide(t){document.removeEventListener("blur",this,!0)}onAfterShow(t){document.addEventListener("blur",this,!0),this.input&&(this.input.focus(),window.setTimeout((()=>{const t=this.input;t?t.focus():console.warn("Input went away before focusing")}),0))}onActivateRequest(t){this.isAttached&&this.show()}}const U="cm-CitationSelector";function Z(t){return f.createElement("span",{className:"cm-title"},t.title?t.match?R.StringExt.highlight(t.title,t.match.indices,H):t.title:"")}function q(t){return(t.given?t.given[0]+". ":"")+t.family}function J(t){var e;const i=t.matches;return i&&t.authors?f.createElement("ul",{className:"cm-authors"},null===(e=t.authors)||void 0===e?void 0:e.map(((t,e)=>{const n=i[e],a=q(t);return f.createElement("span",{className:"cm-author",key:r.UUID.uuid4()},n?R.StringExt.highlight(a,n.indices,H):a)}))):null}function z(t){return f.createElement("span",{className:`cm-source cm-source-${t.source}`},t.source[0])}function G(t,e){return 0!==t.length?e._n("%1 occurrence","%1 occurrences",t.length):""}function Y(t){return{article:t.__("Article"),"article-journal":t.__("Journal Article"),"article-magazine":t.__("Magazine Article"),"article-newspaper":t.__("Newspaper Article"),bill:t.__("Bill"),book:t.__("Book"),broadcast:t.__("Broadcast"),chapter:t.__("Chapter"),classic:t.__("Classic"),collection:t.__("Collection"),dataset:t.__("Dataset"),document:t.__("Document"),entry:t.__("Entry"),"entry-dictionary":t.__("Dictionary Entry"),"entry-encyclopedia":t.__("Encyclopedia Entry"),event:t.__("Event"),figure:t.__("Figure"),graphic:t.__("Graphic"),hearing:t.__("Hearing"),interview:t.__("Interview"),legal_case:t.__("Legal Case"),legislation:t.__("Legislation"),manuscript:t.__("Manuscript"),map:t.__("Map"),motion_picture:t.__("Motion Picture"),musical_score:t.__("Musical Score"),pamphlet:t.__("Pamphlet"),"paper-conference":t.__("Conference Paper"),patent:t.__("Patent"),performance:t.__("Performance"),periodical:t.__("Periodical"),personal_communication:t.__("Personal Communication"),post:t.__("Post"),"post-weblog":t.__("Weblog Post"),regulation:t.__("Regulation"),report:t.__("Report"),review:t.__("Review"),"review-book":t.__("Book review"),software:t.__("Software"),song:t.__("Song"),speech:t.__("Speech"),standard:t.__("Standard"),thesis:t.__("Thesis"),treaty:t.__("Treaty"),webpage:t.__("Webpage")}}const K={filter:t=>null!==t.match&&0!==[t.match.title,t.match.year,t.match.creators].filter((t=>null!==t)).length,sort(t,e){var i,n,a,s;if(null===t.match||null===e.match)return 0;const o=x(null===(i=t.match.title)||void 0===i?void 0:i.score)-x(null===(n=e.match.title)||void 0===n?void 0:n.score),r=(t.match.creators?Math.min(...t.match.creators.map((t=>x(null==t?void 0:t.score)))):1/0)-(e.match.creators?Math.min(...e.match.creators.map((t=>x(null==t?void 0:t.score)))):1/0),c=x(null===(a=t.match.year)||void 0===a?void 0:a.absoluteDifference)-x(null===(s=e.match.year)||void 0===s?void 0:s.absoluteDifference),l=x(e.data.citationsInDocument.length)-x(t.data.citationsInDocument.length);return r||o||c||l},match(t,e){var i,n;e=e.toLowerCase();const a=t.publication,s=R.StringExt.matchSumOfSquares((a.title||"").toLowerCase(),e),o=e.match(/\b((?:19|20)\d{2})\b/g);let r=null;return o&&(r={absoluteDifference:Math.abs(((null===(i=a.date)||void 0===i?void 0:i.getFullYear)?null===(n=a.date)||void 0===n?void 0:n.getFullYear():0)-parseInt(o[0],10))}),{title:s,year:r,creators:a.author?a.author.map((t=>R.StringExt.matchSumOfSquares(q(t).toLowerCase(),e))):null}},initialOptions(t){const e=t.filter((t=>t.citationsInDocument.length>0));return e.length?e.sort(((t,e)=>e.citationsInDocument.length-t.citationsInDocument.length)):t}};function X(t){return""+(t.publication.id||t.publication.DOI||t.publication.title)}class Q extends ${constructor(t){super({model:K}),this.trans=t,this.placeholder=t.__("Start typing title, author, or year"),this.typeNames=Y(t),this.addClass(U)}createID(t){return"c-"+(X(t)||super.createID(t))}dynamicClassForList(t){return new Set([...t.map((t=>t.data.source))]).size>1?"cm-multiple-sources":"cm-single-source"}renderOption(t){var e;const i=t.option.data,n=t.option.match,a=i.publication,s=a.type&&a.type in this.typeNames?this.typeNames[a.type]:a.type,o=G(i.citationsInDocument,this.trans),r=["cm-Option-content"];return i.isFallback&&r.push("cm-mod-fallback"),f.createElement("div",{className:r.join(" ")},f.createElement("div",{className:"cm-Option-main"},f.createElement(z,{source:i.source}),f.createElement(Z,{title:a.title,match:n?n.title:null}),f.createElement("span",{className:"cm-citationCount"},o),f.createElement("span",{className:"cm-year"},null===(e=a.date)||void 0===e?void 0:e.getFullYear()),f.createElement("span",{className:"cm-type"},s)),f.createElement("div",{className:"cm-Option-details"},f.createElement(J,{authors:a.author,matches:null==n?void 0:n.creators})))}}var tt=i(129);const et="citation-manager";class it{constructor(t){this.document=t,this.citations=[]}getCitableItemsFallbackData(){return this.notebookMetadata?this.notebookMetadata.items:null}setCitableItemsFallbackData(t){this.setNotebookMetadata({items:t}),this.updateCellMetadata()}insertAtCursor(t){const e=this.document.content.activeCell;if(e){const i=e.editor.getCursorPosition(),n=e.editor.getOffsetAt(i),a=e.editor;e.model.value.insert(n,t);const s=a.getPositionAt(n+t.length);s&&a.setCursorPosition(s)}}get notebookMetadata(){if(this.document.model)return this.document.model.metadata.get("citation-manager")}addFallbackDataFor(t,e){const i=this.notebookMetadata?this.notebookMetadata.items:{};i[t]={...i[t]||{},...e},this.setNotebookMetadata({items:i})}setNotebookMetadata(t){if(!this.document.model)return void console.warn("Cannot update notebook metadata of",this.document," - no model");const e=this.notebookMetadata||{};for(const[i,n]of Object.entries(t))e[i]=n;this.document.model.metadata.set("citation-manager",e)}getCitationStyle(){const t=this.notebookMetadata;if(t)return t.style}setCitationStyle(t){this.document.model?this.setNotebookMetadata({style:t}):console.warn("Cannot set style on",this.document," - no model")}insertBibliography(t){this.insertAtCursor(this.formatBibliography(t))}formatBibliography(t){return`\x3c!-- BIBLIOGRAPHY START --\x3e${t}\x3c!-- BIBLIOGRAPHY END --\x3e`}formatCitation(t){return`<cite id="${t.citationId}">${t.text}</cite>`}insertCitation(t){this.insertAtCursor(this.formatCitation(t));const e=this.document.content.activeCell;if(!e)return;const i=e.model.metadata.get(et)||{};e.model.metadata.set(et,{citations:{...i.citations,[t.citationId]:t.items}})}updateCitation(t){const e=new RegExp(`<cite id=["']${t.citationId}["'][^>]*?>([\\s\\S]*?)<\\/cite>`);let i=0;this.markdownCells.forEach((n=>{const a=n.model.value.text,s=a.search(e);if(-1!==s){const o=this.formatCitation(t);o!==a.slice(s,s+o.length)&&(n.model.value.text=a.replace(e,this.formatCitation(t))),i+=1}})),0===i?console.warn("Failed to update citation",t,"- no matches found"):i>1&&console.warn("Citation",t,"appears in more than one cell with the same ID; please correct it manually")}updateBibliography(t){const e=/(?<=<!-- BIBLIOGRAPHY START -->)([\s\S]*?)(?=<!-- BIBLIOGRAPHY END -->)/;this.markdownCells.forEach((i=>{const n=i.model.value.text;n.match(/<!-- BIBLIOGRAPHY START -->/)&&(i.model.value.text=n.replace(e,t),-1===n.search(e)&&console.warn("Failed to update bibliography",t,"in",n))}))}chooseCells(t){switch(t){case"all":return this.markdownCells;case"after-cursor":return this.selectMarkdownCells(this.document.content.activeCellIndex,1/0);case"before-cursor":return this.selectMarkdownCells(0,this.document.content.activeCellIndex)}}*iterateCitationsByCell(t){for(const e of this.chooseCells(t)){const t=e.model.metadata.get(et),i=D(e.model.value.text,{host:e.node},t?t.citations:{});yield{cell:e,cellCitations:i}}}findCitations(t){const e=[];for(const{cellCitations:i}of this.iterateCitationsByCell(t))e.push(...i);return e}updateCellMetadata(){for(const{cell:t,cellCitations:e}of this.iterateCitationsByCell("all"))0===e.length?t.model.metadata.delete(et):t.model.metadata.set(et,{citations:Object.fromEntries(e.map((t=>[t.citationId,t.items])))})}get markdownCells(){return this.document.content.widgets.filter((t=>"markdown"===t.model.type))}selectMarkdownCells(t,e){return this.document.content.widgets.slice(t,e).filter((t=>"markdown"===t.model.type))}addCitationMetadata(t,e){let i=t.model.metadata.get(et);i||(i={citations:{}});for(const t of e)i.citations[t.citationId]=t.items;t.model.metadata.set(et,i)}}class nt{constructor(t,e){this.manager=t,this.app=e}createNew(t,e){const i=new u.CommandToolbarButton({commands:this.app.commands,id:l.insertCitation});i.addClass("addCitationButton");const n=new u.CommandToolbarButton({commands:this.app.commands,id:l.insertBibliography});return n.addClass("addBibliographyButton"),t.toolbar.insertItem(10,"addCitation",i),t.toolbar.insertItem(11,"addBibliography",n),new tt.DisposableDelegate((()=>{i.dispose(),n.dispose()}))}}var at=i(351),st=i(572);const ot="citation-manager";function rt(t){const e=t.preview.citations.map((e=>{const i=e.context.excerpt;return f.createElement("p",{key:"cm-preview-"+e.citationId},i.before.slice(-t.maxExcerptSize),f.createElement("span",{dangerouslySetInnerHTML:{__html:e.text}}),i.after.slice(0,t.maxExcerptSize))}));return f.createElement("div",{key:"style-preview-"+t.preview.style.id},f.createElement("h3",null,t.preview.style.info.title),f.createElement("div",{className:"cm-StylePreview-content"},f.createElement("div",{className:"cm-previewContext"},e),f.createElement("h4",null,"Bibliography"),f.createElement("div",{dangerouslySetInnerHTML:{__html:t.preview.bibliography}})))}const ct={filter(t){var e,i;return!!(null===(e=t.match)||void 0===e?void 0:e.title)||!!(null===(i=t.match)||void 0===i?void 0:i.shortTitle)},match(t,e){e=e.toLowerCase();const i=t.style;return{title:R.StringExt.matchSumOfSquares((i.info.title||"").toLowerCase(),e),shortTitle:R.StringExt.matchSumOfSquares((i.info.shortTitle||"").toLowerCase(),e)}},sort(t,e){var i,n,a,s,o,r,c,l;return x(null===(n=null===(i=t.match)||void 0===i?void 0:i.shortTitle)||void 0===n?void 0:n.score)-x(null===(s=null===(a=e.match)||void 0===a?void 0:a.shortTitle)||void 0===s?void 0:s.score)||x(null===(r=null===(o=t.match)||void 0===o?void 0:o.title)||void 0===r?void 0:r.score)-x(null===(l=null===(c=e.match)||void 0===c?void 0:c.title)||void 0===l?void 0:l.score)}};class lt extends ${constructor(t,e){super({model:ct}),this.trans=t,this.previewProvider=e,this.preferredFields=["generic-base"],this.addClass("cm-StyleSelector"),this.previewChanged=new g.Signal(this),this.activeChanged.connect(((t,e)=>{this.previewChanged.emit(f.createElement("div",null,this.trans.__("Loading preview..."))),this.renderPreview(e).then((t=>this.previewChanged.emit(t)))}))}async renderPreview(t){if(!t)return f.createElement("div",null,this.trans.__("No style selected"));try{const e=await this.previewProvider.previewStyle(t.style,4);return f.createElement(rt,{preview:e,maxExcerptSize:50})}catch(t){return t.reason?f.createElement("div",null,t.reason):f.createElement("div",null,this.trans.__("Preview not available"))}}getInitialOptions(){return this.options.filter((t=>this.preferredFields.some((e=>t.style.info.fields.includes(e)))))}renderOption(t){const e=t.option.data.style.info,i=t.option.match;return f.createElement("div",{className:"cm-Option-content"},f.createElement("span",{className:"cm-short-title"},e.shortTitle?[i&&i.shortTitle?R.StringExt.highlight(e.shortTitle,i.shortTitle.indices,H):e.shortTitle,": "]:""),f.createElement("span",{className:"cm-title"},i&&i.title?R.StringExt.highlight(e.title,i.title.indices,H):e.title))}render(){return f.createElement("div",{className:"cm-StyleSelector-panels"},super.render(),f.createElement("div",{className:"cm-StylePreview"},f.createElement(u.UseSignal,{signal:this.previewChanged},((t,e)=>e||null))))}}const dt=new d.LabIcon({name:"citation:add",svgstr:h}),ht=new d.LabIcon({name:"citation:bibliography",svgstr:'<svg width="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n  <g class="jp-icon3 jp-icon-selectable" fill="#4F4F4F">\n    <path d="M17.5 14.33C18.29 14.33 19.13 14.41 20 14.57V16.07C19.38 15.91 18.54 15.83 17.5 15.83C15.6 15.83 14.11 16.16 13 16.82V15.13C14.17 14.6 15.67 14.33 17.5 14.33M13 12.46C14.29 11.93 15.79 11.67 17.5 11.67C18.29 11.67 19.13 11.74 20 11.9V13.4C19.38 13.24 18.54 13.16 17.5 13.16C15.6 13.16 14.11 13.5 13 14.15M17.5 10.5C15.6 10.5 14.11 10.82 13 11.5V9.84C14.23 9.28 15.73 9 17.5 9C18.29 9 19.13 9.08 20 9.23V10.78C19.26 10.59 18.41 10.5 17.5 10.5M21 18.5V7C19.96 6.67 18.79 6.5 17.5 6.5C15.45 6.5 13.62 7 12 8V19.5C13.62 18.5 15.45 18 17.5 18C18.69 18 19.86 18.16 21 18.5M17.5 4.5C19.85 4.5 21.69 5 23 6V20.56C23 20.68 22.95 20.8 22.84 20.91C22.73 21 22.61 21.08 22.5 21.08C22.39 21.08 22.31 21.06 22.25 21.03C20.97 20.34 19.38 20 17.5 20C15.45 20 13.62 20.5 12 21.5C10.66 20.5 8.83 20 6.5 20C4.84 20 3.25 20.36 1.75 21.07C1.72 21.08 1.68 21.08 1.63 21.1C1.59 21.11 1.55 21.12 1.5 21.12C1.39 21.12 1.27 21.08 1.16 21C1.05 20.89 1 20.78 1 20.65V6C2.34 5 4.18 4.5 6.5 4.5C8.83 4.5 10.66 5 12 6C13.34 5 15.17 4.5 17.5 4.5Z" />\n  </g>\n</svg>'}),ut=new d.LabIcon({name:"citation:bookshelf",svgstr:'<svg width="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n  <g class="jp-icon3 jp-icon-selectable" fill="#4F4F4F">\n    <path d="M9 3V18H12V3H9M12 5L16 18L19 17L15 4L12 5M5 5V18H8V5H5M3 19V21H21V19H3Z" />\n  </g>\n</svg>'}),mt=new d.LabIcon({name:"citation:palette",svgstr:'<svg width="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n  <g class="jp-icon3 jp-icon-selectable" fill="#4F4F4F">\n    <path d="M17.5,12A1.5,1.5 0 0,1 16,10.5A1.5,1.5 0 0,1 17.5,9A1.5,1.5 0 0,1 19,10.5A1.5,1.5 0 0,1 17.5,12M14.5,8A1.5,1.5 0 0,1 13,6.5A1.5,1.5 0 0,1 14.5,5A1.5,1.5 0 0,1 16,6.5A1.5,1.5 0 0,1 14.5,8M9.5,8A1.5,1.5 0 0,1 8,6.5A1.5,1.5 0 0,1 9.5,5A1.5,1.5 0 0,1 11,6.5A1.5,1.5 0 0,1 9.5,8M6.5,12A1.5,1.5 0 0,1 5,10.5A1.5,1.5 0 0,1 6.5,9A1.5,1.5 0 0,1 8,10.5A1.5,1.5 0 0,1 6.5,12M12,3A9,9 0 0,0 3,12A9,9 0 0,0 12,21A1.5,1.5 0 0,0 13.5,19.5C13.5,19.11 13.35,18.76 13.11,18.5C12.88,18.23 12.73,17.88 12.73,17.5A1.5,1.5 0 0,1 14.23,16H16A5,5 0 0,0 21,11C21,6.58 16.97,3 12,3Z" />\n  </g>\n</svg>'});function pt(t){return f.createElement("div",{className:"lm-Widget jp-ToolbarButton jp-Toolbar-item",onClick:t.execute,title:t.tooltip},f.createElement("button",{className:"bp3-button bp3-minimal jp-ToolbarButtonComponent minimal jp-Button"},f.createElement("span",{className:"bp3-button-text"},f.createElement("span",{className:"jp-ToolbarButtonComponent-icon"},f.createElement(t.icon.react,null)),t.label)))}const gt="cm-citeprocjs-cpal-attribution";function ft(t){return f.createElement("div",{className:"cm-ReferenceDetails"},f.createElement("code",null,JSON.stringify(t.publication,null,4)))}function bt(t){const e=t.citations.map((e=>f.createElement("li",{onClick:()=>e.host.scrollIntoView(),title:t.clickLabel},e.excerpt.before.slice(-t.excerptMaxSpan),f.createElement("span",{dangerouslySetInnerHTML:{__html:e.excerpt.citation}}),e.excerpt.after.slice(0,t.excerptMaxSpan))));return f.createElement("div",{className:"cm-CitationsInContext"},f.createElement("span",{className:"cm-CitationsInContext-label"},t.label),f.createElement("ul",{className:"cm-CitationsInContext-list"},e))}class vt extends W{constructor(t,e){super({model:K}),this.trans=t,this.commands=e,this.optionModel=K,this.placeholder=t.__("Start typing title, author, or year"),this.typeNames=Y(t),this.addClass(U),this.addClass("cm-ReferenceBrowser")}createID(t){return"c-"+(X(t)||super.createID(t))}render(){return f.createElement("div",{className:"cm-ReferenceBrowser"},f.createElement("div",{className:"cm-ButtonBar jp-Toolbar jp-scrollbar-tiny"},f.createElement(pt,{icon:d.refreshIcon,execute:()=>this.commands.execute(l.updateReferences),tooltip:this.trans.__("Update references")}),f.createElement(pt,{icon:mt,execute:()=>this.commands.execute(l.changeBibliographyStyle),tooltip:this.trans.__("Change citation style")})),super.render(),f.createElement("div",{className:gt},"Citation Manager extension uses ",f.createElement("i",null,"citeproc.js")," which is © Frank Bennett; ",f.createElement("i",null,"citeproc-js")," implements the"," ",f.createElement("a",{href:"https://citationstyles.org/"},"Citation Style Language"),"."))}onAfterAttach(t){super.onAfterAttach(t),window.setTimeout((()=>{const t=this.node.querySelector("."+gt);t&&t.classList.add("cm-mod-hidden")}),3e4)}renderOption(t){var e,i;const n=t.option.data,a=t.option.match,s=n.publication,o=s.type&&s.type in this.typeNames?this.typeNames[s.type]:s.type,r=G(n.citationsInDocument,this.trans);return f.createElement("div",{className:"cm-Option-content"},f.createElement("div",{className:"cm-Option-main"},f.createElement(z,{source:n.source}),f.createElement(Z,{title:s.title,match:a?a.title:null}),f.createElement("span",{className:"cm-citationCount",title:r},0!==n.citationsInDocument.length?"("+n.citationsInDocument.length+")":""),f.createElement("span",{className:"cm-year",title:null===(e=s.date)||void 0===e?void 0:e.toUTCString()},null===(i=s.date)||void 0===i?void 0:i.getFullYear()),f.createElement("span",{className:"cm-type"},o)),f.createElement("div",{className:"cm-Option-details"},f.createElement(J,{authors:s.author,matches:null==a?void 0:a.creators})),f.createElement("div",{className:"cm-Option-active-card"},f.createElement("div",{className:"cm-ButtonBar"},f.createElement(pt,{icon:d.fileIcon,execute:()=>this.commands.execute(l.open,s),tooltip:"Open in JupyterLab"}),f.createElement(pt,{icon:d.launcherIcon,execute:()=>window.open("https://doi.org/"+s.DOI),tooltip:"Open in new browser window"}),f.createElement(pt,{icon:d.buildIcon,execute:()=>(0,u.showDialog)({body:f.createElement(ft,{publication:s}),buttons:[u.Dialog.okButton()]}),tooltip:"Show full metadata"})),f.createElement("div",{className:"cm-abstract cm-collapsed",onClick:t=>{t.target.classList.remove("cm-collapsed")}},s.abstract),0!==n.citationsInDocument.length?f.createElement(bt,{citations:n.citationsInDocument,excerptMaxSpan:50,label:this.trans._n("Cited %1 time in this document:","Cited %1 times in this document:",n.citationsInDocument.length),clickLabel:this.trans.__("Click to scroll to this citation.")}):null))}}const yt="https:"===window.location.protocol,wt={id:"jupyterlab-citation-manager:opener",autoStart:!0,requires:[],optional:[m.ITranslator,n.ILayoutRestorer],activate:(t,e,i)=>{let n=0;const a=e.load("jupyterlab-citation-manager"),s="jupyterlab-citation-manager",o=new u.WidgetTracker({namespace:s});t.commands.addCommand(l.open,{label:t=>a.__('Open "%1"',t.title),execute:e=>{const i=e.URL||(e.DOI?"https://doi.org/"+e.DOI:""),a=e.title;if(e.newBrowserTab||yt&&"https:"!==at.URLExt.parse(i).protocol)return void window.open(i);const r=function(t,e){const i=new u.IFrame({sandbox:["allow-scripts","allow-forms"]});i.url=t,i.title.label=e,i.id=`${s}-${++n}`,i.title.icon=d.fileIcon;const a=new u.MainAreaWidget({content:i});return a.addClass("jp-Help"),a}(i,a);return o.add(r),t.shell.add(r,"main"),r}}),i&&i.restore(o,{command:l.open,args:t=>({URL:t.content.url,title:t.content.title.label}),name:t=>t.content.url})}};class Ct{constructor(t){this.trans=t,this.name="cite2c",this.bibliographyPattern=/<div class=["']cite2c-biblio["']><\/div>/,this.catchAllPattern=this.citationSearchPattern(".*?")}detect(t,e){const i=this.metadata(t),n={citationsDetected:0,bibliographiesDetected:0};return i?(O(t).map((t=>{const e=t.model.value.text,i=e.match(this.catchAllPattern),a=e.match(this.bibliographyPattern);n.citationsDetected+=i?i.length:0,n.bibliographiesDetected+=a?a.length:0})),n):n}metadata(t){return t.model&&t.model.metadata.get("cite2c")||null}citationSearchPattern(t){return new RegExp(`<cite data-cite=["']${t}["'](?:\\/>|><\\/cite>)`,"g")}async migrateFrom(t,e){const i=this.metadata(t),n={migratedCitationsCount:0,bibliographyMigrated:!1,failures:[],aborted:!1};if(!t.model)return{...n,aborted:!0,message:this.trans.__("temporarily could not access notebook metadata")};if(!i)return{...n,aborted:!0,message:this.trans.__("cite2c metadata absent")};if(!i.citations)return{...n,aborted:!0,message:this.trans.__("cite2c metadata detected, but no citations to convert")};console.log("Converting cite2c citations");const a=Object.fromEntries(Object.keys(i.citations).map((t=>[t,[{id:t,source:"cite2c"}]])));return O(t).forEach((t=>{var i;const s=D(t.model.value.text,{host:t.node},a).filter((t=>{var e;return!!(null===(e=null==t?void 0:t.data)||void 0===e?void 0:e.cite)||(n.failures.push(this.trans.__("Skipping potential cite2c citation: %1 - `data-cite` attribute missing.",JSON.stringify(t))),!1)})).map((t=>{var e;return t.citationId="cite2c-"+(null===(e=null==t?void 0:t.data)||void 0===e?void 0:e.cite),t}));let o=t.model.value.text;for(const t of s){const a=this.citationSearchPattern(null===(i=null==t?void 0:t.data)||void 0===i?void 0:i.cite),r=(o.match(a)||[]).length;0===r&&n.failures.push(this.trans.__("Could not migrate cite2c citation: %1: %2 pattern has no matches",JSON.stringify(t),JSON.stringify(a))),o=o.replace(a,e.formatCitation(t));const c=(o.match(a)||[]).length;0!==c&&n.failures.push(this.trans.__("Could not migrate cite2c citation: %1: %2 out of %3 matches migrated",JSON.stringify(s),r-c,r)),n.migratedCitationsCount+=r-c}o=o.replace(this.bibliographyPattern,e.formatBibliography("")),t.model.value.text=o,e.addCitationMetadata(t,s)})),e.addFallbackDataFor("cite2c",i.citations),0===n.failures.length?t.model.metadata.delete("cite2c"):n.message=this.trans.__("Migration could not be completed; the cite2c metadata were kept to allow manual migration"),n}}const _t={id:"jupyterlab-citation-manager:format:cite2c",requires:[c],optional:[m.ITranslator],autoStart:!0,activate:(t,e,i)=>{console.log("JupyterLab cite2c format is activated!");const n=(i=i||m.nullTranslator).load("jupyterlab-citation-manager");e.registerFormat(new Ct(n))}};function It(t){const e=/https?:\/\/(?:dx\\.)?doi\.org\/(?<doi>.*)/.exec(t);return(null==e?void 0:e.groups)?e.groups.doi:t}class St{constructor(t){this.trans=t,this.name="Markdown DOI",this.catchAllPattern=this.citationSearchPattern(".*?")}citationSearchPattern(t=".*?"){return new RegExp(`\\[(?<text>\\([^)\\]]+?\\))]\\((?<url>https?:\\/\\/(?:dx\\.)?doi\\.org\\/${t})\\)`,"g")}detect(t,e){const i={citationsDetected:0,bibliographiesDetected:0};return O(t).map((t=>{const e=t.model.value.text.match(this.catchAllPattern);i.citationsDetected+=e?e.length:0})),i}async migrateFrom(t,e){const i={migratedCitationsCount:0,bibliographyMigrated:!1,failures:[],aborted:!1},n={},a=new RegExp(this.catchAllPattern.source,""),s=new Set(...e.citations.map((t=>t.citationId)));for(const o of O(t)){let t=o.model.value.text;const r=t.match(this.catchAllPattern),c=r?r.length:0;if(!r)continue;const l=[];for(const o of r){const r=a.exec(o);if(null==r?void 0:r.groups)try{const i=r.groups.url,a=await fetch(i,{method:"GET",headers:{Accept:"application/vnd.citationstyles.csl+json"}}),c=It(i),d=c in n?n[c]:await a.json(),h=d.DOI||c;n[h]=d;const u={...d,citationId:A(s),text:r.groups.text,context:{},items:[{source:"DOI",id:h}]};l.push(u),s.add(u.citationId),t=t.replace(o,e.formatCitation(u))}catch(t){i.failures.push(this.trans.__("Could not convert citation %1: %2",o,JSON.stringify(t)))}else i.failures.push("Internal error: could not get match groups for DOI")}o.model.value.text=t;const d=(t.match(this.catchAllPattern)||[]).length;0!==d&&i.failures.push(this.trans.__("Could not migrate markdown DOI citations: %1: %2 out of %3 matches migrated",JSON.stringify(r),c-d,c)),e.addCitationMetadata(o,l),i.migratedCitationsCount+=c-d}return e.addFallbackDataFor("DOI",n),i}}const kt={id:"jupyterlab-citation-manager:format:markdownDOI",requires:[c],optional:[m.ITranslator],autoStart:!0,activate:(t,e,i)=>{console.log("JupyterLab cite2c format is activated!");const n=(i=i||m.nullTranslator).load("jupyterlab-citation-manager");e.registerFormat(new St(n))}},Et="jupyterlab-citation-manager:plugin";class xt{constructor(t,e){this.trans=t,this.selector=new lt(t,e),this.styles=[],this.isReady=this.fetchStylesList()}async selectStyle(){return await this.isReady,await this.selector.getItem(this.styles.map((t=>({style:t}))))}updateStyles(){this.isReady=this.fetchStylesList()}fetchStylesList(){return async function(t="",e={}){const i=st.ServerConnection.makeSettings(),n=at.URLExt.join(i.baseUrl,ot,t);let a;try{a=await st.ServerConnection.makeRequest(n,e,i)}catch(t){throw new st.ServerConnection.NetworkError(t)}const s=await a.json();if(!a.ok)throw new st.ServerConnection.ResponseError(a,s.message);return s}("styles").then((t=>{console.debug("Styles are ready"),this.styles=t.styles}))}}function At(t){return t.source+"|"+t.id}class Mt{constructor(t,e,i,n){this.notebookTracker=t,this.trans=i,this.referenceBrowser=n,this.defaultStyleID="apa.csl",this.currentAdapter=null,this.outputFormat="html",this.progress=new g.Signal(this),this.styles=new xt(i,this),this.selector=new Q(i),this.formats=[],this.selector.hide(),this.adapters=new WeakMap,this.processors=new WeakMap,this.localeCache=new Map,t.widgetAdded.connect(((t,e)=>{const i=new o.dx((async()=>{await this.createAllReadyPromiseWrapper().promise,this.processFromScratch(e).catch(console.warn)}),2e3);e.content.modelContentChanged.connect((()=>{i.invoke().catch(console.warn)})),e.context.ready.then((()=>{this.offerMigration(e).catch(console.warn)})),e.context.saveState.connect(((t,i)=>{"started"===i&&this.beforeSave(e)}))})),t.currentChanged.connect(((t,e)=>{e&&(this.currentAdapter=this.getAdapter(e),this.updateReferenceBrowser(this.currentAdapter))})),this.providers=new Map,e&&e.load(Et).then((t=>{t.changed.connect(this.updateSettings),this.updateSettings(t)})),this.allReady=this.createAllReadyPromiseWrapper()}createAllReadyPromiseWrapper(){const t="cancelled";let e=()=>0,i=()=>0;const n=new Promise(((n,a)=>{i=n,e=()=>a(t)})),a={promise:Promise.race([Promise.all([this.styles,...this.providers.values()].map((t=>t.isReady))),n]).catch((e=>{if(e!==t)throw e})).then((()=>{a.done=!0,i()})),cancel:e,done:!1};return a}registerFormat(t){this.formats.push(t),console.log(`${t.name} format registered`),this.notebookTracker.currentWidget&&this.offerMigration(this.notebookTracker.currentWidget).catch(console.warn)}async offerMigration(t){const e=this.getAdapter(t);for(const i of this.formats){const n=i.detect(t,e);if(0!==n.citationsDetected||0!==n.bibliographiesDetected){const a=u.Dialog.okButton({label:this.trans.__("Migrate")});if((await(0,u.showDialog)({title:this.trans.__("Importing %1 citations is possible",i.name),body:this.trans.__("Detected %1 citation in %2 format. Would you like to migrate these citations to Citation Manager format?",n.citationsDetected,i.name),buttons:[u.Dialog.cancelButton(),a],defaultButton:1})).button===a){const n=await i.migrateFrom(t,e);n.aborted&&await(0,u.showErrorMessage)(this.trans.__("Migration from %1 failed",i.name),n.message),0!==n.failures.length&&await(0,u.showErrorMessage)(this.trans.__("Migration from %1 was not complete",i.name),this.trans.__("There were %1 failures: ",n.failures.length)+JSON.stringify(n.failures)+"\n\n"+n.message),console.log(`${n.migratedCitationsCount} citations migrated from ${i.name}`),await this.processFromScratch(t)}}}}async previewStyle(t,e){if(!this.notebookTracker.currentWidget)throw{reason:"Please switch to a document that supports citations to generate a preview"};const i=this.notebookTracker.currentWidget,n=this.getAdapter(i).citations.slice(0,e);if(0===n.length)throw{reason:"No citations in the document to generate the preview from."};const a=await this.createProcessor(t.id),s=[];for(const t of this.processCitations(a,n))s.push(t);return{citations:s,bibliography:this.processBibliography(a.makeBibliography()),style:t}}*processCitations(t,e){let i=0;for(const n of e){const[e]=t.appendCitationCluster({properties:{noteIndex:i},citationID:n.citationId,citationItems:n.items.map((t=>({id:At(t)})))});yield{...n,text:e[1]},i++}}async processFromScratch(t,e){const i={label:this.trans.__("Updating citations"),tooltip:this.trans.__("Citation manager is updating citations and bibliography...")};this.progress.emit({...i,state:"started"});const n=this.getAdapter(t);e||(e=n.getCitationStyle());const a=this.createProcessor(e);this.processors.set(t,a),n.citations=n.findCitations("all");const s=await a;let o=0;for(const t of this.processCitations(s,n.citations))o+=1,n.updateCitation(t),this.progress.emit({...i,state:"ongoing",value:o/n.citations.length});const r=s.makeBibliography();n.updateBibliography(this.processBibliography(r)),this.progress.emit({...i,state:"completed"}),this.updateReferenceBrowser(n)}updateReferenceBrowser(t){if(!t){const e=this.notebookTracker.currentWidget;e&&(t=this.getAdapter(e))}const e=t?t.citations:[],i=t?t.getCitableItemsFallbackData():null;this.referenceBrowser.getItem(this.collectOptions(e,i)).catch(console.warn)}updateSettings(t){this.defaultStyleID=t.get("defaultStyle").composite,this.outputFormat=t.get("outputFormat").composite}registerReferenceProvider(t){console.debug("Adding reference provider",t),this.providers.set(t.id,t),this.allReady.done||this.allReady.cancel(),this.createAllReadyPromiseWrapper().promise.then((()=>{console.debug("All providers ready, updating reference browser..."),this.updateReferenceBrowser()}))}async updateReferences(){return Promise.all([...this.providers.values()].map((t=>t.updatePublications(!0)))).then((()=>{this.updateReferenceBrowser()}))}collectOptions(t,e){const i=[],n=new Map,a=new M((()=>[]));for(const e of t)for(const t of e.items){const i=At(t),s=a.get(i);s.push(e.context),a.set(i,s),n.set(i,t)}const s=new Set;for(const t of this.providers.values())for(const e of t.citableItems.values()){const n=t.id+"|"+e.id;s.add(n),i.push({source:t.id,publication:L(e),citationsInDocument:a.get(n)})}const o=[];for(const[t,r]of n.entries())if(!s.has(t)){if(!e){o.push({item:r,reason:"fallback missing"});continue}if(!(r.source in e)){o.push({item:r,reason:"fallback for this source missing"});continue}const n=e[r.source];if(!(r.id in n)){o.push({item:r,reason:"fallback for this item missing"});continue}i.push({source:r.source,publication:n[r.id],isFallback:!0,citationsInDocument:a.get(t)})}return o.length&&console.warn("Failed to get fallback metadata for some items and those cannot be displayed",o),i}getAdapter(t){let e=this.adapters.get(t);if(!e){e=new it(t),this.adapters.set(t,e);const i=e.getCitationStyle();this.processors.set(t,this.createProcessor(i))}if(!e)throw Error("This should not happen");return e}embedBibliographyEntry(t){return t?`<a href="#${t}">↑</a>`:""}beforeSave(t){const e=this.getAdapter(t),i=e.findCitations("all"),n=new M((()=>new Set));for(const t of i)for(const e of t.items){const t=n.get(e.source);n.set(e.source,t.add(e.id))}console.log(n),e.setCitableItemsFallbackData(Object.fromEntries([...n.entries()].map((([t,e])=>[t,Object.fromEntries([...e.values()].sort().map((e=>{const i=this.retrieveItem(At({source:t,id:e}));return i.id=e,[e,i]})))]))))}addCitation(t){const e=document.activeElement,i=this.getAdapter(t);i.citations=i.findCitations("all");const n=i?i.getCitableItemsFallbackData():null,a=i.citations,s=this.collectOptions(a,n);this.selector.getItem(s).then((async e=>{const n=await this.processors.get(t);if(!n)return void console.warn("Could not find a processor for ",t);const a=i.findCitations("before-cursor"),s=i.findCitations("after-cursor"),o=A(new Set([...a.map((t=>t.citationId)),...s.map((t=>t.citationId))])),r=Object.fromEntries(a.map(((t,e)=>[e,t]))),c=Object.fromEntries(s.map(((t,e)=>[e+1,t]))),l=n.processCitationCluster({properties:{noteIndex:a.length},citationItems:[{id:e.source+"|"+e.publication.id}],citationID:o},a.map(((t,e)=>[t.citationId,e])),s.map(((t,e)=>[t.citationId,e+1])))[1];console.log("citations to update",l);for(const[t,n]of l)if(t===a.length){const t={id:e.publication.id,source:e.source};i.insertCitation({text:n,items:[t],citationId:o})}else{let e;if(t in c)e=c[t];else{if(!(t in r)){console.warn("Could not locate citation with index",t,"in",r,"nor",c);continue}e=r[t]}i.updateCitation({...e,text:n})}const d=n.makeBibliography();i.updateBibliography(this.processBibliography(d)),i.citations=i.findCitations("all"),this.updateReferenceBrowser(i)})).finally((()=>{this.refocusWidget(t,e)}))}refocusWidget(t,e){setTimeout((()=>{var i;e?null===(i=e)||void 0===i||i.focus():t.content.widgets[t.content.activeCellIndex].editor.focus()}),0)}processBibliography(t){return"\n"+(t[0].bibstart||"")+t[1].join("")+(t[0].bibend||"")+"\n"}async createProcessor(t){return t||(t=this.defaultStyleID),async function(t="",e={}){const i=st.ServerConnection.makeSettings(),n=at.URLExt.join(i.baseUrl,ot,t);let a;try{a=await st.ServerConnection.makeRequest(n,e,i)}catch(t){throw new st.ServerConnection.NetworkError(t)}const s=await a.text();if(!a.ok)throw new st.ServerConnection.ResponseError(a,s);return s}(at.URLExt.join("styles",t)).then((e=>(console.log(`Success fetching style ${t} from server extension`),new N.Engine(this,e)))).catch((()=>(console.warn(`Could not get the style ${t} from server extension; falling back to the fetching directly from GitHub.`),async function(t,e="GET"){const i=new XMLHttpRequest;return new Promise(((n,a)=>{i.open(e,t,!0),i.onload=t=>n({response:i,progress:t}),i.onerror=a,i.send(null)}))}(`https://raw.githubusercontent.com/citation-style-language/styles/master/${t}`).then((t=>{const e=t.response.responseText;return new N.Engine(this,e)}))))).then((t=>(t.setOutputFormat(this.outputFormat),t)))}async addBibliography(t){console.debug("Adding bibliography");const e=this.getAdapter(t),i=await this.processors.get(t);if(!i)return void console.warn("Could not find a processor for ",t);const n=i.makeBibliography();e.insertBibliography(this.processBibliography(n))}changeStyle(t){const e=document.activeElement;this.styles.selectStyle().then((e=>{console.log("selected style",e),this.getAdapter(t).setCitationStyle(e.style.id),this.processFromScratch(t,e.style.id).then(console.warn)})).finally((()=>{this.refocusWidget(t,e)}))}retrieveItem(t){var e;const i=t.indexOf("|"),n=t.slice(0,i),a=t.slice(i+1);let s=null===(e=this.providers.get(n))||void 0===e?void 0:e.citableItems.get(a);if(!s&&this.currentAdapter){const t=this.currentAdapter.getCitableItemsFallbackData();t?n in t?(a in t[n]||console.log(`${a} not in fallback for ${n}`),s=t[n][a]):console.log(`${n} not in fallback data`):console.log(`No fallback data to resolve ${a}`)}if(!s)throw Error(`Provider did not provide item for ${a}`);return{...s,id:t}}retrieveLocale(t){let e=this.localeCache.get(t);if(e)return e;const i=new XMLHttpRequest;return i.open("GET","https://raw.githubusercontent.com/citation-style-language/locales/master/locales-"+t+".xml",!1),i.send(null),e=i.responseText,this.localeCache.set(t,e),e}}const Ot=[{id:Et,autoStart:!0,requires:[s.INotebookTracker],optional:[a.ISettingRegistry,m.ITranslator,u.ICommandPalette,b.IStatusBar,n.ILayoutRestorer],provides:c,activate:(t,e,i,n,a,s,o)=>{console.log("JupyterLab Citation Manager extension is activated!");const r=(n=n||m.nullTranslator).load("jupyterlab-citation-manager"),c=new vt(r,t.commands),h=new Mt(e,i,r,c);!function(t,e,i,n,a){console.log("adding commands");const s=()=>!!e.currentWidget,o=t=>()=>{const i=e.currentWidget;i?t(i):console.warn("Panel not found for command")};if(t.commands.addCommand(l.insertCitation,{label:n.__("Insert citation"),caption:n.__("Insert citation at the current cursor position in the active document."),execute:o(i.addCitation.bind(i)),isEnabled:s,icon:dt}),t.commands.addCommand(l.insertBibliography,{label:n.__("Insert bibliography"),caption:n.__("Insert bibliography at the current cursor position in the active document."),execute:o(i.addBibliography.bind(i)),isEnabled:s,icon:ht}),t.commands.addCommand(l.changeBibliographyStyle,{label:n.__("Change bibliography style"),caption:n.__("Change bibliography style for the active document."),execute:o(i.changeStyle.bind(i)),isEnabled:s,icon:mt}),t.commands.addCommand(l.updateReferences,{label:n.__("Update references"),caption:n.__("Synchronise the references from all providers."),execute:i.updateReferences.bind(i),icon:d.refreshIcon}),a){const t=n.__("Citation Manager");a.addItem({command:l.insertCitation,category:t}),a.addItem({command:l.insertBibliography,category:t}),a.addItem({command:l.changeBibliographyStyle,category:t}),a.addItem({command:l.updateReferences,category:t})}}(t,e,h,r,a),s&&s.registerStatusItem(Et,{item:new v(h.progress),rank:900});try{c.id="jupyterlab-citation-manager:reference-browser",c.title.icon=ut,c.title.caption="Reference Browser",c.show(),t.shell.add(c,"left",{rank:850}),o&&o.add(c,c.id)}catch(t){console.warn("Could not attach the reference browser to the sidebar",t)}return t.docRegistry.addWidgetExtension("Notebook",new nt(h,t)),h}},S,_t,kt,wt]}}]);