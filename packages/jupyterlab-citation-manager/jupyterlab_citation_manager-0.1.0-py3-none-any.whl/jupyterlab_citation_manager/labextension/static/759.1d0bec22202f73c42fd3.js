(self.webpackChunkjupyterlab_citation_manager=self.webpackChunkjupyterlab_citation_manager||[]).push([[759],{759:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>Ie,itemIdToPrimitive:()=>Ce});var n=i(194),s=i(406),o=i(749),a=i(114),r=i(797);const c=new r.Token("@krassowski/citation-manager:ICitationManager");var l;!function(e){e.open="cm:open-reference",e.insertCitation="cm:insert-citation",e.insertBibliography="cm:insert-bibliography",e.changeBibliographyStyle="cm:change-bibliography-style",e.updateReferences="cm:update-references"}(l||(l={}));var d=i(79);const h='<svg width="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n  <g class="jp-icon3 jp-icon-selectable" fill="#4F4F4F">\n    <path d="M13 19C13 20.1 13.3 21.12 13.81 22H6C4.89 22 4 21.11 4 20V4C4 2.9 4.89 2 6 2H7V9L9.5 7.5L12 9V2H18C19.1 2 20 2.89 20 4V13.09C19.67 13.04 19.34 13 19 13C15.69 13 13 15.69 13 19M20 18V15H18V18H15V20H18V23H20V20H23V18H20Z" />\n  </g>\n</svg>';var m=i(567),u=i(160),p=i(276),g=i(168),f=i(271),v=i(80);class b extends m.ReactWidget{constructor(e){super(),this.signal=e}render(){return f.createElement(m.UseSignal,{signal:this.signal},((e,t)=>t?("started"===t.state&&(t.value=0),"ongoing"===t.state&&t.value?f.createElement("div",{className:"cm-ProgressBar",title:t.tooltip||""},f.createElement("span",null,t.label||""),f.createElement(v.ProgressBar,{percentage:t.value})):f.createElement("div",null)):null))}}const y=new d.LabIcon({name:"citation:zotero",svgstr:h}),w="jupyterlab-citation-manager:zotero";function C(e){const t=new Map;for(const i of e.split(",")){const e=i.split(";"),n=/<(.*?)>/.exec(e[0]);if(!n)throw"Could not parse URL of Zotero link";const s=/ ?rel="(.*?)"/.exec(e[1]);if(!s)throw"Could not parse rel of Zotero link";const o=s[1];t.set(o,{rel:o,url:n[1]})}return t}class _{constructor(e){this.headers=e,this.backoffSeconds=this.parseIntIfPresent("Backoff"),this.lastModifiedVersion=this.headers.get("Last-Modified-Version"),this.apiVersion=this.headers.get("Zotero-API-Version")}parseIntIfPresent(e){const t=this.headers.get(e);if(!t)return null;try{return parseInt(t,10)}catch(e){return console.warn("Failed to parse backoff time from Zotero API response headers"),null}}}class I{constructor(e,t,i){this.settings=e,this.trans=t,this.state=i,this.id="zotero",this.name="Zotero",this.icon=y,this._serverURL=null,this._key=null,this._user=null,this.lastModifiedLibraryVersion=null,this.apiVersion="3",this.persistentCacheVersion="0..",this.progress=new g.Signal(this),this.citableItems=new Map,e.changed.connect(this.updateSettings,this);const n=[this.updateSettings(e)];i&&n.push(this.restoreStateFromCache(i)),this.isReady=Promise.all(n),this.backoffPassed=new Promise((e=>{e()}))}async restoreStateFromCache(e){return new Promise((t=>{e.fetch(w).then((e=>{if(e){const t=e;if(t.apiVersion&&t.apiVersion!==this.apiVersion)return;if(t.persistentCacheVersion&&t.persistentCacheVersion!==this.persistentCacheVersion)return;this.lastModifiedLibraryVersion=t.lastModifiedLibraryVersion,t.citableItems&&(this.citableItems=new Map([...Object.entries(t.citableItems)]),console.log(`Restored ${this.citableItems.size} citable items from cache`)),this.updateCacheState()}else console.log("No previous state found for Zotero in the StateDB (it is normal on first run)")})).catch(console.warn).finally((()=>t()))}))}async fetch(e,t={},i=!1,n=!1){if(!this._key){const e=await m.InputDialog.getPassword({title:this.trans.__("Configure Zotero API Access _key"),label:this.trans.__("In order to access your Zotero collection you need to configure Zotero API key.\n          You can generate the API key after logging to www.zotero.org.\n          The key looks like this: P9NiFoyLeZu2bZNvvuQPDWsd.")});if(!e.value)return;this._key=e.value,this.settings.set("_key",this._key).catch(console.warn)}const s={"Zotero-API-Key":this._key,"Zotero-API-Version":this.apiVersion};return!n&&i&&this.lastModifiedLibraryVersion&&(s["If-Modified-Since-Version"]=this.lastModifiedLibraryVersion),await this.backoffPassed,fetch(this._serverURL+"/"+e+"?"+new URLSearchParams(t),{method:"GET",headers:s}).then((e=>(this.processResponseHeaders(e.headers,i),e)))}processResponseHeaders(e,t){const i=new _(e);this.handleBackoff(i.backoffSeconds),t&&i.lastModifiedVersion&&(this.lastModifiedLibraryVersion=i.lastModifiedVersion),i.apiVersion&&i.apiVersion!==this.apiVersion&&console.warn(`Zotero servers moved to a newer version API (${i.apiVersion}, but this client only supports ${this.apiVersion}); please consider contributing a code to update this client to use the latest API`)}handleBackoff(e){e&&(this.backoffPassed=new Promise((t=>{window.setTimeout(t,e)})))}async updatePublications(e=!1){var t;const i={label:this.trans.__("Zotero sync."),tooltip:this.trans.__("Connector for Zotero is synchronizing references...")};this.progress.emit({...i,state:"started"});const n=await this.loadAll("users/"+(null===(t=this._user)||void 0===t?void 0:t.id)+"/items","csljson","items",!0,e,(e=>{this.progress.emit({...i,state:"ongoing",value:e})})).finally((()=>{this.progress.emit({...i,state:"completed"})}));return n?(console.log(`Fetched ${null==n?void 0:n.length} citable items from Zotero`),this.citableItems=new Map((n||[]).map((e=>{const t=e;return[t.id+"",t]}))),this.updateCacheState().catch(console.warn)):console.log("No new items fetched from Zotero"),[...this.citableItems.values()]}async updateCacheState(){if(!this.state)return;const e={persistentCacheVersion:this.persistentCacheVersion,apiVersion:this.apiVersion,lastModifiedLibraryVersion:this.lastModifiedLibraryVersion,citableItems:Object.fromEntries(this.citableItems)};return this.state.save(w,e)}async loadAll(e,t="csljson",i,n=!0,s=!1,o){var a;let r=await this.fetch(e,{format:t},n,s);if(304===(null==r?void 0:r.status))return console.log(`Received 304 status (${null==r?void 0:r.statusText}), skipping...`),null;const c=[],l=parseInt(null==r?void 0:r.headers.get("Total-Results"),10)||1e4;let d=0,h=!1;for(;!h&&d<=l;){if(!r)return void console.log("Could not retrieve all pages for ",e);c.push(r);const i=null===(a=C(null==r?void 0:r.headers.get("Link")).get("next"))||void 0===a?void 0:a.url;if(i){const s=Object.fromEntries(new URLSearchParams(new URL(i).search).entries());s.start&&(d+=parseInt(s.start,10),o&&o(100*d/l)),r=await this.fetch(e,{...s,format:t},n,!0)}else h=!0,o&&o(100)}const m=[];for(const e of c){let t=await e.json();i&&(t=t[i]);for(const e of t)m.push(e)}return m}reloadKey(){return this.fetch("keys/"+this._key).then((e=>{if(e)return e.json().then((e=>(this._user={name:e.username,id:e.userID},this.updatePublications())));console.error(e)}))}updateSettings(e){return this._key=e.composite.key,this._serverURL=e.composite.server,this.reloadKey()}}const E={id:w,requires:[c,s.ISettingRegistry],optional:[u.ITranslator,p.IStateDB,v.IStatusBar],autoStart:!0,activate:(e,t,i,n,s,o)=>{console.log("JupyterLab citation manager provider of Zotero is activated!");const a=(n=n||u.nullTranslator).load("jupyterlab-citation-manager");i.load(E.id).then((e=>{const i=new I(e,a,s);t.registerReferenceProvider(i),console.log("jupyterlab-citation-manager:zotero settings loaded:",e.composite),o&&o.registerStatusItem(w,{item:new b(i.progress),rank:900})})).catch((e=>{console.error("Failed to load settings for jupyterlab-citation-manager:zotero.",e)}))}};var S=i(137),k=i.n(S);function x(e){return null==e?1/0:e}class A{constructor(e){this.factory=e,this.map=new Map}get(e){return this.map.has(e)?this.map.get(e):this.factory(e)}set(e,t){this.map.set(e,t)}entries(){return this.map.entries()}keys(){return this.map.keys()}values(){return this.map.values()}}function B(e){return e&&(null==e?void 0:e.textContent)||""}function L(e,t,i){const n=k()(e),s=document.createElement("div");return s.innerHTML=n,[...s.querySelectorAll("cite").values()].map((e=>{const n={before:B(e.previousSibling),citation:e.innerHTML,after:B(e.nextSibling)};let s=i[e.id?e.id:e.dataset.cite];return s||(s=e.dataset.items?e.dataset.items.startsWith("[")?JSON.parse(e.dataset.items):[{source:e.dataset.source,id:e.dataset.items}]:[]),{citationId:e.id,items:s,text:e.innerHTML,data:e.dataset,context:{...t,excerpt:n}}}))}function M(e){return new Date(e)}function O(e){let t;return e.issued&&(t=function(e){if("string"==typeof e)return M(e);if(e.edtf)return M(e.edtf);if(e.raw)return new Date(e.raw);if(e.literal)return new Date(e.literal);if(e["date-parts"]){const t=e["date-parts"][0];if(1===t.length)return new Date(parseInt(t[0]+"",10),6);if(2===t.length)return new Date(...t.map((e=>parseInt(e+"",10))));if(3===t.length)return new Date(...t.map((e=>parseInt(e+"",10))));console.warn(`Don't know how to parse date-parts: ${t}`)}return new Date}(e.issued)),{...e,date:t}}var R=i(686),P=i(850),N=i(706),D=i(608);const T="cm-mod-active",V="lm-mod-focused";function j(e){return f.createElement("mark",{key:r.UUID.uuid4()},e)}class F extends m.ReactWidget{constructor(e){super(),this.input=null,this.defaultConfig={debounceRate:250,debounceOptionNumberThreshold:200},this.placeholder="Search",this._config={...this.defaultConfig,...e},this._debouncedChanged=new a.dx((()=>{this.emitChangedSignal()}),this._config.debounceRate),this._query="",this.options=[],this._optionsChanged=new g.Signal(this),this._filteredOptions=this.transformOptions(this.getInitialOptions()),this._reject=()=>0,this._accept=e=>0,this._previousPromise=null,this.activeIndex=0,this.activeChanged=new g.Signal(this),this.node.tabIndex=0}get model(){return this._config.model}emitChangedSignal(){this._optionsChanged.emit(this._filteredOptions)}createID(e){return JSON.stringify(e)}getInitialOptions(){return this.model.initialOptions?this.model.initialOptions(this.options):[]}transformOptions(e){return e.map((e=>({data:e,match:null,id:this.createID(e)})))}getOptionNodes(){return this.node.querySelectorAll(".cm-OptionsList li.cm-Option")}handleInput(e){this._query=e.target.value,this._filteredOptions=this.options.map((e=>({match:this.model.match(e,this._query),data:e,id:this.createID(e)}))).filter(this.model.filter).sort(this.model.sort),this.setActiveIndex(0),this._debouncedChanged.invoke().catch(console.warn)}renderOption(e){const t=e.option.data;return f.createElement("div",{className:"cm-Option-content"},JSON.stringify(t))}dynamicClassForList(e){return""}render(){return f.createElement("div",{className:"cm-Selector"},f.createElement("div",{className:"cm-SearchField-outer-wrapper"},f.createElement("div",{className:"cm-SearchField-wrapper"},f.createElement("input",{placeholder:this.placeholder,onInput:this.handleInput.bind(this),className:"cm-SearchField",ref:e=>{this.input=e},onBlur:()=>{this.input&&this.input.parentElement&&this.input.parentElement.classList.remove(V)},onFocus:()=>{this.input&&this.input.parentElement&&this.input.parentElement.classList.add(V)},autoFocus:!0}),f.createElement(d.searchIcon.react,{className:"cm-SearchIcon"}))),f.createElement(m.UseSignal,{signal:this._optionsChanged},((e,t)=>{const i=t;if(!i)return"";const n=i.map(((e,t)=>{const i=this.activeIndex===t?"cm-Option cm-mod-active":"cm-Option",n=this.renderOption.bind(this);return f.createElement("li",{className:i,key:e.id,onClick:(()=>{this.acceptOption(e.data)}).bind(this)},f.createElement(n,{option:e}))}));return f.createElement("ul",{className:`cm-OptionsList ${this.dynamicClassForList(i)}`},n)}).bind(this)))}hideAndReset(){this.hide(),this._previousPromise&&this._reject(),this._previousPromise=null,this.input&&(this.input.value="")}acceptOption(e){if(e||this._filteredOptions.length&&(e=this._filteredOptions[this.activeIndex].data),e){const t=this._filteredOptions.findIndex((t=>t.data===e));-1!==t&&this.setActiveIndex(t),this._accept(e),this._previousPromise=null}else this._previousPromise&&(this._reject(),this._previousPromise=null)}setActiveIndex(e){const t=this.getOptionNodes();if(!t.length)return;t[this.activeIndex].classList.remove(T),this.activeIndex=e;const i=t[this.activeIndex];t[this.activeIndex].classList.add(T),D.ElementExt.scrollIntoViewIfNeeded(i.parentElement,i),this.activeChanged.emit(this._filteredOptions[this.activeIndex].data)}cycle(e){const t=this.activeIndex,i=this._filteredOptions;let n;switch(e){case"down":n=t===i.length-1?0:t+1;break;case"up":n=0===t?i.length-1:t-1;break;case"page down":n=t+10>=i.length-1?i.length-1:t+10;break;case"page up":n=t-10<=0?0:t-10;break;case"end":n=i.length-1;break;case"home":n=0}this.setActiveIndex(n)}_evtKeydown(e){switch(e.keyCode){case 13:this.acceptOption();break;case 40:this.cycle("down");break;case 38:this.cycle("up");break;case 34:this.cycle("page down");break;case 33:this.cycle("page up");break;case 35:this.cycle("end");break;case 36:this.cycle("home")}}getItem(e){return this._previousPromise&&this._reject(),this.setActiveIndex(0),this.options=e,this._filteredOptions=this.transformOptions(this.getInitialOptions()),this._optionsChanged.emit(this._filteredOptions),this.setActiveIndex(0),new Promise(((e,t)=>{this._accept=e,this._reject=t}))}handleEvent(e){switch(e.type){case"keydown":this._evtKeydown(e)}}onAfterAttach(e){super.onAfterAttach(e),this.node.addEventListener("keydown",this,!0)}onAfterDetach(e){this.node.removeEventListener("keydown",this,!0)}}class H extends F{constructor(e){super(e),this.addClass("cm-ModalSelector"),this.node.tabIndex=0}_evtKeydown(e){switch(e.keyCode){case 27:e.stopPropagation(),e.preventDefault(),this.hideAndReset();break;default:super._evtKeydown(e)}}getItem(e){const t=super.getItem(e);return this.show(),this.isAttached||this.attach(),t}acceptOption(e){super.acceptOption(e),this.hideAndReset()}attach(){N.Widget.attach(this,document.body)}detach(){N.Widget.detach(this)}handleEvent(e){switch(super.handleEvent(e),e.type){case"blur":this.node.contains(e.target)&&!this.node.contains(e.relatedTarget)&&(e.stopPropagation(),this.hideAndReset());break;case"contextmenu":e.preventDefault(),e.stopPropagation()}}onAfterAttach(e){super.onAfterAttach(e),this.node.addEventListener("contextmenu",this,!0)}onAfterDetach(e){super.onAfterDetach(e),this.node.removeEventListener("contextmenu",this,!0)}onBeforeHide(e){document.removeEventListener("blur",this,!0)}onAfterShow(e){document.addEventListener("blur",this,!0),this.input&&(this.input.focus(),window.setTimeout((()=>{const e=this.input;e?e.focus():console.warn("Input went away before focusing")}),0))}onActivateRequest(e){this.isAttached&&this.show()}}const $="cm-CitationSelector";function U(e){return f.createElement("span",{className:"cm-title"},e.title?e.match?P.StringExt.highlight(e.title,e.match.indices,j):e.title:"")}function W(e){return(e.given?e.given[0]+". ":"")+e.family}function Z(e){var t;const i=e.matches;return i&&e.authors?f.createElement("ul",{className:"cm-authors"},null===(t=e.authors)||void 0===t?void 0:t.map(((e,t)=>{const n=i[t],s=W(e);return f.createElement("span",{className:"cm-author",key:r.UUID.uuid4()},n?P.StringExt.highlight(s,n.indices,j):s)}))):null}function q(e){return f.createElement("span",{className:`cm-source cm-source-${e.source}`},e.source[0])}function z(e,t){return 0!==e.length?t._n("%1 occurrence","%1 occurrences",e.length):""}function G(e){return{article:e.__("Article"),"article-journal":e.__("Journal Article"),"article-magazine":e.__("Magazine Article"),"article-newspaper":e.__("Newspaper Article"),bill:e.__("Bill"),book:e.__("Book"),broadcast:e.__("Broadcast"),chapter:e.__("Chapter"),classic:e.__("Classic"),collection:e.__("Collection"),dataset:e.__("Dataset"),document:e.__("Document"),entry:e.__("Entry"),"entry-dictionary":e.__("Dictionary Entry"),"entry-encyclopedia":e.__("Encyclopedia Entry"),event:e.__("Event"),figure:e.__("Figure"),graphic:e.__("Graphic"),hearing:e.__("Hearing"),interview:e.__("Interview"),legal_case:e.__("Legal Case"),legislation:e.__("Legislation"),manuscript:e.__("Manuscript"),map:e.__("Map"),motion_picture:e.__("Motion Picture"),musical_score:e.__("Musical Score"),pamphlet:e.__("Pamphlet"),"paper-conference":e.__("Conference Paper"),patent:e.__("Patent"),performance:e.__("Performance"),periodical:e.__("Periodical"),personal_communication:e.__("Personal Communication"),post:e.__("Post"),"post-weblog":e.__("Weblog Post"),regulation:e.__("Regulation"),report:e.__("Report"),review:e.__("Review"),"review-book":e.__("Book review"),software:e.__("Software"),song:e.__("Song"),speech:e.__("Speech"),standard:e.__("Standard"),thesis:e.__("Thesis"),treaty:e.__("Treaty"),webpage:e.__("Webpage")}}const Y={filter:e=>null!==e.match&&0!==[e.match.title,e.match.year,e.match.creators].filter((e=>null!==e)).length,sort(e,t){var i,n,s,o;if(null===e.match||null===t.match)return 0;const a=x(null===(i=e.match.title)||void 0===i?void 0:i.score)-x(null===(n=t.match.title)||void 0===n?void 0:n.score),r=(e.match.creators?Math.min(...e.match.creators.map((e=>x(null==e?void 0:e.score)))):1/0)-(t.match.creators?Math.min(...t.match.creators.map((e=>x(null==e?void 0:e.score)))):1/0),c=x(null===(s=e.match.year)||void 0===s?void 0:s.absoluteDifference)-x(null===(o=t.match.year)||void 0===o?void 0:o.absoluteDifference),l=x(t.data.citationsInDocument.length)-x(e.data.citationsInDocument.length);return r||a||c||l},match(e,t){var i,n;t=t.toLowerCase();const s=e.publication,o=P.StringExt.matchSumOfSquares((s.title||"").toLowerCase(),t),a=t.match(/\b((?:19|20)\d{2})\b/g);let r=null;return a&&(r={absoluteDifference:Math.abs(((null===(i=s.date)||void 0===i?void 0:i.getFullYear)?null===(n=s.date)||void 0===n?void 0:n.getFullYear():0)-parseInt(a[0],10))}),{title:o,year:r,creators:s.author?s.author.map((e=>P.StringExt.matchSumOfSquares(W(e).toLowerCase(),t))):null}},initialOptions(e){const t=e.filter((e=>e.citationsInDocument.length>0));return t.length?t.sort(((e,t)=>t.citationsInDocument.length-e.citationsInDocument.length)):e}};function J(e){return""+(e.publication.id||e.publication.DOI||e.publication.title)}class K extends H{constructor(e){super({model:Y}),this.trans=e,this.placeholder=e.__("Start typing title, author, or year"),this.typeNames=G(e),this.addClass($)}createID(e){return"c-"+(J(e)||super.createID(e))}dynamicClassForList(e){return new Set([...e.map((e=>e.data.source))]).size>1?"cm-multiple-sources":"cm-single-source"}renderOption(e){var t;const i=e.option.data,n=e.option.match,s=i.publication,o=s.type&&s.type in this.typeNames?this.typeNames[s.type]:s.type,a=z(i.citationsInDocument,this.trans),r=["cm-Option-content"];return i.isFallback&&r.push("cm-mod-fallback"),f.createElement("div",{className:r.join(" ")},f.createElement("div",{className:"cm-Option-main"},f.createElement(q,{source:i.source}),f.createElement(U,{title:s.title,match:n?n.title:null}),f.createElement("span",{className:"cm-citationCount"},a),f.createElement("span",{className:"cm-year"},null===(t=s.date)||void 0===t?void 0:t.getFullYear()),f.createElement("span",{className:"cm-type"},o)),f.createElement("div",{className:"cm-Option-details"},f.createElement(Z,{authors:s.author,matches:null==n?void 0:n.creators})))}}var X=i(129);const Q="citation-manager";class ee{constructor(e){this.document=e,this.citations=[]}getCitableItemsFallbackData(){return this.notebookMetadata?this.notebookMetadata.items:null}setCitableItemsFallbackData(e){this.setNotebookMetadata({items:e}),this.updateCellMetadata()}insertAtCursor(e){const t=this.document.content.activeCell;if(t){const i=t.editor.getCursorPosition(),n=t.editor.getOffsetAt(i);t.model.value.insert(n,e)}}get notebookMetadata(){if(this.document.model)return this.document.model.metadata.get("citation-manager")}setNotebookMetadata(e){if(!this.document.model)return void console.warn("Cannot update notebook metadata of",this.document," - no model");const t=this.notebookMetadata||{};for(const[i,n]of Object.entries(e))t[i]=n;this.document.model.metadata.set("citation-manager",t)}getCitationStyle(){const e=this.notebookMetadata;if(e)return e.style}setCitationStyle(e){this.document.model?this.setNotebookMetadata({style:e}):console.warn("Cannot set style on",this.document," - no model")}insertBibliography(e){this.insertAtCursor(this.formatBibliography(e))}formatBibliography(e){return`\x3c!-- BIBLIOGRAPHY START --\x3e${e}\x3c!-- BIBLIOGRAPHY END --\x3e`}formatCitation(e){return`<cite id="${e.citationId}">${e.text}</cite>`}insertCitation(e){this.insertAtCursor(this.formatCitation(e));const t=this.document.content.activeCell;if(!t)return;const i=t.model.metadata.get(Q)||{};t.model.metadata.set(Q,{citations:{...i.citations,[e.citationId]:e.items}})}updateCitation(e){const t=new RegExp(`<cite id=["']${e.citationId}["'][^>]*?>([\\s\\S]*?)<\\/cite>`);let i=0;this.markdownCells.forEach((n=>{const s=n.model.value.text,o=s.search(t);if(-1!==o){const a=this.formatCitation(e);a!==s.slice(o,o+a.length)&&(n.model.value.text=s.replace(t,this.formatCitation(e))),i+=1}})),0===i?console.warn("Failed to update citation",e,"- no matches found"):i>1&&console.warn("Citation",e,"appears in more than one cell with the same ID; please correct it manually")}updateBibliography(e){const t=/(?<=<!-- BIBLIOGRAPHY START -->)([\s\S]*?)(?=<!-- BIBLIOGRAPHY END -->)/;this.markdownCells.forEach((i=>{const n=i.model.value.text;n.match(/<!-- BIBLIOGRAPHY START -->/)&&(i.model.value.text=n.replace(t,e),-1===n.search(t)&&console.warn("Failed to update bibliography",e,"in",n))}))}chooseCells(e){switch(e){case"all":return this.markdownCells;case"after-cursor":return this.selectMarkdownCells(this.document.content.activeCellIndex,1/0);case"before-cursor":return this.selectMarkdownCells(0,this.document.content.activeCellIndex)}}async migrateFormat(){if(!this.document.model)return!1;const e=this.document.model.metadata.get("cite2c");if(!e)return!1;if(!e.citations)return console.log("cite2c metadata detected, but no citations to convert"),!1;let t=!0;console.log("Converting cite2c citations");const i=Object.fromEntries(Object.keys(e.citations).map((e=>[e,[{id:e,source:"cite2c"}]])));this.chooseCells("all").forEach((e=>{var n;const s=L(e.model.value.text,{host:e.node},i).filter((e=>{var i;return!!(null===(i=null==e?void 0:e.data)||void 0===i?void 0:i.cite)||(t=!1,console.log("Skipping potential cite2c citation:",e,"- no data-cite detected."),!1)})).map((e=>{var t;return e.citationId="cite2c-"+(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.cite),e}));let o=e.model.value.text;for(const e of s){const i=new RegExp(`<cite data-cite=["']${null===(n=null==e?void 0:e.data)||void 0===n?void 0:n.cite}["'](?:\\/>|><\\/cite>)`,"g");0===(o.match(i)||[]).length&&(t=!1,console.error(`Could not migrate cite2c citation: ${e}: ${i} has no matches`)),o=o.replace(i,this.formatCitation(e)),0!==(o.match(i)||[]).length&&(t=!1,console.error(`Could not migrate cite2c citation: ${e}: ${i} some matches remained`))}o=o.replace(/<div class=["']cite2c-biblio["']><\/div>/,this.formatBibliography("")),e.model.value.text=o;let a=e.model.metadata.get(Q);a||(a={citations:{}});for(const e of s)a.citations[e.citationId]=e.items;e.model.metadata.set(Q,a)}));const n=this.notebookMetadata?this.notebookMetadata.items:{};return n.cite2c={...n.cite2c||{},...e.citations},this.setNotebookMetadata({items:n}),t?this.document.model.metadata.delete("cite2c"):console.warn("Could not fully migrate from cite2c"),!0}*iterateCitationsByCell(e){for(const t of this.chooseCells(e)){const e=t.model.metadata.get(Q),i=L(t.model.value.text,{host:t.node},e?e.citations:{});yield{cell:t,cellCitations:i}}}findCitations(e){const t=[];for(const{cellCitations:i}of this.iterateCitationsByCell(e))t.push(...i);return t}updateCellMetadata(){for(const{cell:e,cellCitations:t}of this.iterateCitationsByCell("all"))0===t.length?e.model.metadata.delete(Q):e.model.metadata.set(Q,{citations:Object.fromEntries(t.map((e=>[e.citationId,e.items])))})}get markdownCells(){return this.document.content.widgets.filter((e=>"markdown"===e.model.type))}selectMarkdownCells(e,t){return this.document.content.widgets.slice(e,t).filter((e=>"markdown"===e.model.type))}}class te{constructor(e,t){this.manager=e,this.app=t}createNew(e,t){const i=new m.CommandToolbarButton({commands:this.app.commands,id:l.insertCitation});i.addClass("addCitationButton");const n=new m.CommandToolbarButton({commands:this.app.commands,id:l.insertBibliography});return n.addClass("addBibliographyButton"),e.toolbar.insertItem(10,"addCitation",i),e.toolbar.insertItem(11,"addBibliography",n),new X.DisposableDelegate((()=>{i.dispose(),n.dispose()}))}}var ie=i(351),ne=i(572);const se="citation-manager";function oe(e){const t=e.preview.citations.map((t=>{const i=t.context.excerpt;return f.createElement("p",{key:"cm-preview-"+t.citationId},i.before.slice(-e.maxExcerptSize),f.createElement("span",{dangerouslySetInnerHTML:{__html:t.text}}),i.after.slice(0,e.maxExcerptSize))}));return f.createElement("div",{key:"style-preview-"+e.preview.style.id},f.createElement("h3",null,e.preview.style.info.title),f.createElement("div",{className:"cm-StylePreview-content"},f.createElement("div",{className:"cm-previewContext"},t),f.createElement("h4",null,"Bibliography"),f.createElement("div",{dangerouslySetInnerHTML:{__html:e.preview.bibliography}})))}const ae={filter(e){var t,i;return!!(null===(t=e.match)||void 0===t?void 0:t.title)||!!(null===(i=e.match)||void 0===i?void 0:i.shortTitle)},match(e,t){t=t.toLowerCase();const i=e.style;return{title:P.StringExt.matchSumOfSquares((i.info.title||"").toLowerCase(),t),shortTitle:P.StringExt.matchSumOfSquares((i.info.shortTitle||"").toLowerCase(),t)}},sort(e,t){var i,n,s,o,a,r,c,l;return x(null===(n=null===(i=e.match)||void 0===i?void 0:i.shortTitle)||void 0===n?void 0:n.score)-x(null===(o=null===(s=t.match)||void 0===s?void 0:s.shortTitle)||void 0===o?void 0:o.score)||x(null===(r=null===(a=e.match)||void 0===a?void 0:a.title)||void 0===r?void 0:r.score)-x(null===(l=null===(c=t.match)||void 0===c?void 0:c.title)||void 0===l?void 0:l.score)}};class re extends H{constructor(e,t){super({model:ae}),this.trans=e,this.previewProvider=t,this.preferredFields=["generic-base"],this.addClass("cm-StyleSelector"),this.previewChanged=new g.Signal(this),this.activeChanged.connect(((e,t)=>{this.previewChanged.emit(f.createElement("div",null,this.trans.__("Loading preview..."))),this.renderPreview(t).then((e=>this.previewChanged.emit(e)))}))}async renderPreview(e){if(!e)return f.createElement("div",null,this.trans.__("No style selected"));try{const t=await this.previewProvider.previewStyle(e.style,4);return f.createElement(oe,{preview:t,maxExcerptSize:50})}catch(e){return e.reason?f.createElement("div",null,e.reason):f.createElement("div",null,this.trans.__("Preview not available"))}}getInitialOptions(){return this.options.filter((e=>this.preferredFields.some((t=>e.style.info.fields.includes(t)))))}renderOption(e){const t=e.option.data.style.info,i=e.option.match;return f.createElement("div",{className:"cm-Option-content"},f.createElement("span",{className:"cm-short-title"},t.shortTitle?[i&&i.shortTitle?P.StringExt.highlight(t.shortTitle,i.shortTitle.indices,j):t.shortTitle,": "]:""),f.createElement("span",{className:"cm-title"},i&&i.title?P.StringExt.highlight(t.title,i.title.indices,j):t.title))}render(){return f.createElement("div",{className:"cm-StyleSelector-panels"},super.render(),f.createElement("div",{className:"cm-StylePreview"},f.createElement(m.UseSignal,{signal:this.previewChanged},((e,t)=>t||null))))}}const ce=new d.LabIcon({name:"citation:add",svgstr:h}),le=new d.LabIcon({name:"citation:bibliography",svgstr:'<svg width="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n  <g class="jp-icon3 jp-icon-selectable" fill="#4F4F4F">\n    <path d="M17.5 14.33C18.29 14.33 19.13 14.41 20 14.57V16.07C19.38 15.91 18.54 15.83 17.5 15.83C15.6 15.83 14.11 16.16 13 16.82V15.13C14.17 14.6 15.67 14.33 17.5 14.33M13 12.46C14.29 11.93 15.79 11.67 17.5 11.67C18.29 11.67 19.13 11.74 20 11.9V13.4C19.38 13.24 18.54 13.16 17.5 13.16C15.6 13.16 14.11 13.5 13 14.15M17.5 10.5C15.6 10.5 14.11 10.82 13 11.5V9.84C14.23 9.28 15.73 9 17.5 9C18.29 9 19.13 9.08 20 9.23V10.78C19.26 10.59 18.41 10.5 17.5 10.5M21 18.5V7C19.96 6.67 18.79 6.5 17.5 6.5C15.45 6.5 13.62 7 12 8V19.5C13.62 18.5 15.45 18 17.5 18C18.69 18 19.86 18.16 21 18.5M17.5 4.5C19.85 4.5 21.69 5 23 6V20.56C23 20.68 22.95 20.8 22.84 20.91C22.73 21 22.61 21.08 22.5 21.08C22.39 21.08 22.31 21.06 22.25 21.03C20.97 20.34 19.38 20 17.5 20C15.45 20 13.62 20.5 12 21.5C10.66 20.5 8.83 20 6.5 20C4.84 20 3.25 20.36 1.75 21.07C1.72 21.08 1.68 21.08 1.63 21.1C1.59 21.11 1.55 21.12 1.5 21.12C1.39 21.12 1.27 21.08 1.16 21C1.05 20.89 1 20.78 1 20.65V6C2.34 5 4.18 4.5 6.5 4.5C8.83 4.5 10.66 5 12 6C13.34 5 15.17 4.5 17.5 4.5Z" />\n  </g>\n</svg>'}),de=new d.LabIcon({name:"citation:bookshelf",svgstr:'<svg width="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n  <g class="jp-icon3 jp-icon-selectable" fill="#4F4F4F">\n    <path d="M9 3V18H12V3H9M12 5L16 18L19 17L15 4L12 5M5 5V18H8V5H5M3 19V21H21V19H3Z" />\n  </g>\n</svg>'}),he=new d.LabIcon({name:"citation:palette",svgstr:'<svg width="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n  <g class="jp-icon3 jp-icon-selectable" fill="#4F4F4F">\n    <path d="M17.5,12A1.5,1.5 0 0,1 16,10.5A1.5,1.5 0 0,1 17.5,9A1.5,1.5 0 0,1 19,10.5A1.5,1.5 0 0,1 17.5,12M14.5,8A1.5,1.5 0 0,1 13,6.5A1.5,1.5 0 0,1 14.5,5A1.5,1.5 0 0,1 16,6.5A1.5,1.5 0 0,1 14.5,8M9.5,8A1.5,1.5 0 0,1 8,6.5A1.5,1.5 0 0,1 9.5,5A1.5,1.5 0 0,1 11,6.5A1.5,1.5 0 0,1 9.5,8M6.5,12A1.5,1.5 0 0,1 5,10.5A1.5,1.5 0 0,1 6.5,9A1.5,1.5 0 0,1 8,10.5A1.5,1.5 0 0,1 6.5,12M12,3A9,9 0 0,0 3,12A9,9 0 0,0 12,21A1.5,1.5 0 0,0 13.5,19.5C13.5,19.11 13.35,18.76 13.11,18.5C12.88,18.23 12.73,17.88 12.73,17.5A1.5,1.5 0 0,1 14.23,16H16A5,5 0 0,0 21,11C21,6.58 16.97,3 12,3Z" />\n  </g>\n</svg>'});function me(e){return f.createElement("div",{className:"lm-Widget jp-ToolbarButton jp-Toolbar-item",onClick:e.execute,title:e.tooltip},f.createElement("button",{className:"bp3-button bp3-minimal jp-ToolbarButtonComponent minimal jp-Button"},f.createElement("span",{className:"bp3-button-text"},f.createElement("span",{className:"jp-ToolbarButtonComponent-icon"},f.createElement(e.icon.react,null)),e.label)))}const ue="cm-citeprocjs-cpal-attribution";function pe(e){return f.createElement("div",{className:"cm-ReferenceDetails"},f.createElement("code",null,JSON.stringify(e.publication,null,4)))}function ge(e){const t=e.citations.map((t=>f.createElement("li",{onClick:()=>t.host.scrollIntoView(),title:e.clickLabel},t.excerpt.before.slice(-e.excerptMaxSpan),f.createElement("span",{dangerouslySetInnerHTML:{__html:t.excerpt.citation}}),t.excerpt.after.slice(0,e.excerptMaxSpan))));return f.createElement("div",{className:"cm-CitationsInContext"},f.createElement("span",{className:"cm-CitationsInContext-label"},e.label),f.createElement("ul",{className:"cm-CitationsInContext-list"},t))}class fe extends F{constructor(e,t){super({model:Y}),this.trans=e,this.commands=t,this.optionModel=Y,this.placeholder=e.__("Start typing title, author, or year"),this.typeNames=G(e),this.addClass($),this.addClass("cm-ReferenceBrowser")}createID(e){return"c-"+(J(e)||super.createID(e))}render(){return f.createElement("div",{className:"cm-ReferenceBrowser"},f.createElement("div",{className:"cm-ButtonBar jp-Toolbar jp-scrollbar-tiny"},f.createElement(me,{icon:d.refreshIcon,execute:()=>this.commands.execute(l.updateReferences),tooltip:this.trans.__("Update references")}),f.createElement(me,{icon:he,execute:()=>this.commands.execute(l.changeBibliographyStyle),tooltip:this.trans.__("Change citation style")})),super.render(),f.createElement("div",{className:ue},"Citation Manager extension uses ",f.createElement("i",null,"citeproc.js")," which is © Frank Bennett; ",f.createElement("i",null,"citeproc-js")," implements the"," ",f.createElement("a",{href:"https://citationstyles.org/"},"Citation Style Language"),"."))}onAfterAttach(e){super.onAfterAttach(e),window.setTimeout((()=>{const e=this.node.querySelector("."+ue);e&&e.classList.add("cm-mod-hidden")}),3e4)}renderOption(e){var t,i;const n=e.option.data,s=e.option.match,o=n.publication,a=o.type&&o.type in this.typeNames?this.typeNames[o.type]:o.type,r=z(n.citationsInDocument,this.trans);return f.createElement("div",{className:"cm-Option-content"},f.createElement("div",{className:"cm-Option-main"},f.createElement(q,{source:n.source}),f.createElement(U,{title:o.title,match:s?s.title:null}),f.createElement("span",{className:"cm-citationCount",title:r},0!==n.citationsInDocument.length?"("+n.citationsInDocument.length+")":""),f.createElement("span",{className:"cm-year",title:null===(t=o.date)||void 0===t?void 0:t.toUTCString()},null===(i=o.date)||void 0===i?void 0:i.getFullYear()),f.createElement("span",{className:"cm-type"},a)),f.createElement("div",{className:"cm-Option-details"},f.createElement(Z,{authors:o.author,matches:null==s?void 0:s.creators})),f.createElement("div",{className:"cm-Option-active-card"},f.createElement("div",{className:"cm-ButtonBar"},f.createElement(me,{icon:d.fileIcon,execute:()=>this.commands.execute(l.open,o),tooltip:"Open in JupyterLab"}),f.createElement(me,{icon:d.launcherIcon,execute:()=>window.open("https://doi.org/"+o.DOI),tooltip:"Open in new browser window"}),f.createElement(me,{icon:d.buildIcon,execute:()=>(0,m.showDialog)({body:f.createElement(pe,{publication:o}),buttons:[m.Dialog.okButton()]}),tooltip:"Show full metadata"})),f.createElement("div",{className:"cm-abstract cm-collapsed",onClick:e=>{e.target.classList.remove("cm-collapsed")}},o.abstract),0!==n.citationsInDocument.length?f.createElement(ge,{citations:n.citationsInDocument,excerptMaxSpan:50,label:this.trans._n("Cited %1 time in this document:","Cited %1 times in this document:",n.citationsInDocument.length),clickLabel:this.trans.__("Click to scroll to this citation.")}):null))}}const ve="https:"===window.location.protocol,be={id:"jupyterlab-citation-manager:opener",autoStart:!0,requires:[],optional:[u.ITranslator,n.ILayoutRestorer],activate:(e,t,i)=>{let n=0;const s=t.load("jupyterlab-citation-manager"),o="jupyterlab-citation-manager",a=new m.WidgetTracker({namespace:o});e.commands.addCommand(l.open,{label:e=>s.__('Open "%1"',e.title),execute:t=>{const i=t.URL||(t.DOI?"https://doi.org/"+t.DOI:""),s=t.title;if(t.newBrowserTab||ve&&"https:"!==ie.URLExt.parse(i).protocol)return void window.open(i);const r=function(e,t){const i=new m.IFrame({sandbox:["allow-scripts","allow-forms"]});i.url=e,i.title.label=t,i.id=`${o}-${++n}`,i.title.icon=d.fileIcon;const s=new m.MainAreaWidget({content:i});return s.addClass("jp-Help"),s}(i,s);return a.add(r),e.shell.add(r,"main"),r}}),i&&i.restore(a,{command:l.open,args:e=>({URL:e.content.url,title:e.content.title.label}),name:e=>e.content.url})}},ye="jupyterlab-citation-manager:plugin";class we{constructor(e,t){this.trans=e,this.selector=new re(e,t),this.styles=[],this.isReady=this.fetchStylesList()}async selectStyle(){return await this.isReady,await this.selector.getItem(this.styles.map((e=>({style:e}))))}updateStyles(){this.isReady=this.fetchStylesList()}fetchStylesList(){return async function(e="",t={}){const i=ne.ServerConnection.makeSettings(),n=ie.URLExt.join(i.baseUrl,se,e);let s;try{s=await ne.ServerConnection.makeRequest(n,t,i)}catch(e){throw new ne.ServerConnection.NetworkError(e)}const o=await s.json();if(!s.ok)throw new ne.ServerConnection.ResponseError(s,o.message);return o}("styles").then((e=>{console.debug("Styles are ready"),this.styles=e.styles}))}}function Ce(e){return e.source+"|"+e.id}class _e{constructor(e,t,i,n){this.notebookTracker=e,this.trans=i,this.referenceBrowser=n,this.defaultStyleID="apa.csl",this.currentAdapter=null,this.progress=new g.Signal(this),this.styles=new we(i,this),this.selector=new K(i),this.selector.hide(),this.adapters=new WeakMap,this.processors=new WeakMap,this.localeCache=new Map,e.widgetAdded.connect(((e,t)=>{const i=new a.dx((async()=>{await this.createAllReadyPromiseWrapper().promise,this.processFromScratch(t).catch(console.warn)}),2e3);t.content.modelContentChanged.connect((()=>{i.invoke().catch(console.warn)})),t.context.ready.then((()=>{this.getAdapter(t).migrateFormat().then((async e=>{e&&(console.log("Migrated citations, will refresh now..."),await this.processFromScratch(t))}))})),t.context.saveState.connect(((e,i)=>{"started"===i&&this.beforeSave(t)}))})),e.currentChanged.connect(((e,t)=>{t&&(this.currentAdapter=this.getAdapter(t),this.updateReferenceBrowser(this.currentAdapter))})),this.providers=new Map,t&&t.load(ye).then((e=>{e.changed.connect(this.updateSettings),this.updateSettings(e)})),this.allReady=this.createAllReadyPromiseWrapper()}createAllReadyPromiseWrapper(){const e="cancelled";let t=()=>0,i=()=>0;const n=new Promise(((n,s)=>{i=n,t=()=>s(e)})),s={promise:Promise.race([Promise.all([this.styles,...this.providers.values()].map((e=>e.isReady))),n]).catch((t=>{if(t!==e)throw t})).then((()=>{s.done=!0,i()})),cancel:t,done:!1};return s}async previewStyle(e,t){if(!this.notebookTracker.currentWidget)throw{reason:"Please switch to a document that supports citations to generate a preview"};const i=this.notebookTracker.currentWidget,n=this.getAdapter(i).citations.slice(0,t);if(0===n.length)throw{reason:"No citations in the document to generate the preview from."};const s=await this.createProcessor(e.id),o=[];for(const e of this.processCitations(s,n))o.push(e);return{citations:o,bibliography:this.processBibliography(s.makeBibliography()),style:e}}*processCitations(e,t){let i=0;for(const n of t){const[t]=e.appendCitationCluster({properties:{noteIndex:i},citationID:n.citationId,citationItems:n.items.map((e=>({id:Ce(e)})))});yield{...n,text:t[1]},i++}}async processFromScratch(e,t){const i={label:this.trans.__("Updating citations"),tooltip:this.trans.__("Citation manager is updating citations and bibliography...")};this.progress.emit({...i,state:"started"});const n=this.getAdapter(e);t||(t=n.getCitationStyle());const s=this.createProcessor(t);this.processors.set(e,s),n.citations=n.findCitations("all");const o=await s;let a=0;for(const e of this.processCitations(o,n.citations))a+=1,n.updateCitation(e),this.progress.emit({...i,state:"ongoing",value:a/n.citations.length});const r=o.makeBibliography();n.updateBibliography(this.processBibliography(r)),this.progress.emit({...i,state:"completed"}),this.updateReferenceBrowser(n)}updateReferenceBrowser(e){if(!e){const t=this.notebookTracker.currentWidget;t&&(e=this.getAdapter(t))}const t=e?e.citations:[],i=e?e.getCitableItemsFallbackData():null;this.referenceBrowser.getItem(this.collectOptions(t,i)).catch(console.warn)}updateSettings(e){this.defaultStyleID=e.get("defaultStyle").composite}registerReferenceProvider(e){console.debug("Adding reference provider",e),this.providers.set(e.id,e),this.allReady.done||this.allReady.cancel(),this.createAllReadyPromiseWrapper().promise.then((()=>{console.debug("All providers ready, updating reference browser..."),this.updateReferenceBrowser()}))}async updateReferences(){return Promise.all([...this.providers.values()].map((e=>e.updatePublications(!0)))).then((()=>{this.updateReferenceBrowser()}))}collectOptions(e,t){const i=[],n=new Map,s=new A((()=>[]));for(const t of e)for(const e of t.items){const i=Ce(e),o=s.get(i);o.push(t.context),s.set(i,o),n.set(i,e)}const o=new Set;for(const e of this.providers.values())for(const t of e.citableItems.values()){const n=e.id+"|"+t.id;o.add(n),i.push({source:e.id,publication:O(t),citationsInDocument:s.get(n)})}const a=[];for(const[e,r]of n.entries())if(!o.has(e)){if(!t){a.push({item:r,reason:"fallback missing"});continue}if(!(r.source in t)){a.push({item:r,reason:"fallback for this source missing"});continue}const n=t[r.source];if(!(r.id in n)){a.push({item:r,reason:"fallback for this item missing"});continue}i.push({source:r.source,publication:n[r.id],isFallback:!0,citationsInDocument:s.get(e)})}return a.length&&console.warn("Failed to get fallback metadata for some items and those cannot be displayed",a),i}_generateRandomID(e){let t=!1,i="";for(;!t;)i=Math.random().toString(36).slice(-5),t=!e.has(i);return i}getAdapter(e){let t=this.adapters.get(e);if(!t){t=new ee(e),this.adapters.set(e,t);const i=t.getCitationStyle();this.processors.set(e,this.createProcessor(i))}if(!t)throw Error("This should not happen");return t}embedBibliographyEntry(e){return e?`<a href="#${e}">↑</a>`:""}beforeSave(e){const t=this.getAdapter(e),i=t.findCitations("all"),n=new A((()=>new Set));for(const e of i)for(const t of e.items){const e=n.get(t.source);n.set(t.source,e.add(t.id))}console.log(n),t.setCitableItemsFallbackData(Object.fromEntries([...n.entries()].map((([e,t])=>[e,Object.fromEntries([...t.values()].sort().map((t=>{const i=this.retrieveItem(Ce({source:e,id:t}));return i.id=t,[t,i]})))]))))}addCitation(e){const t=document.activeElement,i=this.getAdapter(e);i.citations=i.findCitations("all");const n=i?i.getCitableItemsFallbackData():null,s=i.citations,o=this.collectOptions(s,n);this.selector.getItem(o).then((async t=>{const n=await this.processors.get(e);if(!n)return void console.warn("Could not find a processor for ",e);const s=i.findCitations("before-cursor"),o=i.findCitations("after-cursor"),a=new Set([...s.map((e=>e.citationId)),...o.map((e=>e.citationId))]),r=this._generateRandomID(a),c=Object.fromEntries(s.map(((e,t)=>[t,e]))),l=Object.fromEntries(o.map(((e,t)=>[t+1,e]))),d=n.processCitationCluster({properties:{noteIndex:s.length},citationItems:[{id:t.source+"|"+t.publication.id}],citationID:r},s.map(((e,t)=>[e.citationId,t])),o.map(((e,t)=>[e.citationId,t+1])))[1];console.log("citations to update",d);for(const[e,n]of d)if(e===s.length){const e={id:t.publication.id,source:t.source};i.insertCitation({text:n,items:[e],citationId:r})}else{let t;if(e in l)t=l[e];else{if(!(e in c)){console.warn("Could not locate citation with index",e,"in",c,"nor",l);continue}t=c[e]}i.updateCitation({...t,text:n})}const h=n.makeBibliography();i.updateBibliography(this.processBibliography(h)),i.citations=i.findCitations("all"),this.updateReferenceBrowser(i)})).finally((()=>{this.refocusWidget(e,t)}))}refocusWidget(e,t){setTimeout((()=>{var i;t?null===(i=t)||void 0===i||i.focus():e.content.widgets[e.content.activeCellIndex].editor.focus()}),0)}processBibliography(e){return"\n"+(e[0].bibstart||"")+e[1].join("")+(e[0].bibend||"")+"\n"}async createProcessor(e){return e||(e=this.defaultStyleID),async function(e="",t={}){const i=ne.ServerConnection.makeSettings(),n=ie.URLExt.join(i.baseUrl,se,e);let s;try{s=await ne.ServerConnection.makeRequest(n,t,i)}catch(e){throw new ne.ServerConnection.NetworkError(e)}const o=await s.text();if(!s.ok)throw new ne.ServerConnection.ResponseError(s,o);return o}(ie.URLExt.join("styles",e)).then((t=>(console.log(`Success fetching style ${e} from server extension`),new R.Engine(this,t)))).catch((()=>(console.warn(`Could not get the style ${e} from server extension; falling back to the fetching directly from GitHub.`),async function(e,t="GET"){const i=new XMLHttpRequest;return new Promise(((n,s)=>{i.open(t,e,!0),i.onload=e=>n({response:i,progress:e}),i.onerror=s,i.send(null)}))}(`https://raw.githubusercontent.com/citation-style-language/styles/master/${e}`).then((e=>{const t=e.response.responseText;return new R.Engine(this,t)})))))}async addBibliography(e){console.debug("Adding bibliography");const t=this.getAdapter(e),i=await this.processors.get(e);if(!i)return void console.warn("Could not find a processor for ",e);const n=i.makeBibliography();t.insertBibliography(this.processBibliography(n))}changeStyle(e){const t=document.activeElement;this.styles.selectStyle().then((t=>{console.log("selected style",t),this.getAdapter(e).setCitationStyle(t.style.id),this.processFromScratch(e,t.style.id).then(console.warn)})).finally((()=>{this.refocusWidget(e,t)}))}retrieveItem(e){var t;const i=e.indexOf("|"),n=e.slice(0,i),s=e.slice(i+1);let o=null===(t=this.providers.get(n))||void 0===t?void 0:t.citableItems.get(s);if(!o&&this.currentAdapter){const e=this.currentAdapter.getCitableItemsFallbackData();e?n in e?(s in e[n]||console.log(`${s} not in fallback for ${n}`),o=e[n][s]):console.log(`${n} not in fallback data`):console.log(`No fallback data to resolve ${s}`)}if(!o)throw Error(`Provider did not provide item for ${s}`);return{...o,id:e}}retrieveLocale(e){let t=this.localeCache.get(e);if(t)return t;const i=new XMLHttpRequest;return i.open("GET","https://raw.githubusercontent.com/citation-style-language/locales/master/locales-"+e+".xml",!1),i.send(null),t=i.responseText,this.localeCache.set(e,t),t}}const Ie=[{id:ye,autoStart:!0,requires:[o.INotebookTracker],optional:[s.ISettingRegistry,u.ITranslator,m.ICommandPalette,v.IStatusBar,n.ILayoutRestorer],provides:c,activate:(e,t,i,n,s,o,a)=>{console.log("JupyterLab Citation Manager extension is activated!");const r=(n=n||u.nullTranslator).load("jupyterlab-citation-manager"),c=new fe(r,e.commands),h=new _e(t,i,r,c);!function(e,t,i,n,s){console.log("adding commands");const o=()=>!!t.currentWidget,a=e=>()=>{const i=t.currentWidget;i?e(i):console.warn("Panel not found for command")};if(e.commands.addCommand(l.insertCitation,{label:n.__("Insert citation"),caption:n.__("Insert citation at the current cursor position in the active document."),execute:a(i.addCitation.bind(i)),isEnabled:o,icon:ce}),e.commands.addCommand(l.insertBibliography,{label:n.__("Insert bibliography"),caption:n.__("Insert bibliography at the current cursor position in the active document."),execute:a(i.addBibliography.bind(i)),isEnabled:o,icon:le}),e.commands.addCommand(l.changeBibliographyStyle,{label:n.__("Change bibliography style"),caption:n.__("Change bibliography style for the active document."),execute:a(i.changeStyle.bind(i)),isEnabled:o,icon:he}),e.commands.addCommand(l.updateReferences,{label:n.__("Update references"),caption:n.__("Synchronise the references from all providers."),execute:i.updateReferences.bind(i),icon:d.refreshIcon}),s){const e=n.__("Citation Manager");s.addItem({command:l.insertCitation,category:e}),s.addItem({command:l.insertBibliography,category:e}),s.addItem({command:l.changeBibliographyStyle,category:e}),s.addItem({command:l.updateReferences,category:e})}}(e,t,h,r,s),o&&o.registerStatusItem(ye,{item:new b(h.progress),rank:900});try{c.id="jupyterlab-citation-manager:reference-browser",c.title.icon=de,c.title.caption="Reference Browser",c.show(),e.shell.add(c,"left",{rank:850}),a&&a.add(c,c.id)}catch(e){console.warn("Could not attach the reference browser to the sidebar",e)}return e.docRegistry.addWidgetExtension("Notebook",new te(h,e)),h}},E,be]}}]);